<!DOCTYPE html>
<html>

<head>
  <title>What makes us healthy?</title>
  <link rel="stylesheet" href="what-makes-us-healthy.css">
  <script src="d3.v5.js" charset="utf-8"></script>
  <!--<script src="what-makes-us-healthy.js"></script>-->
  <script src="radarChart.js" charset="utf-8"></script>

  <!-- <script src="https://d3js.org/d3.v5.min.js"></script> -->
  <script src="simpleSlider.js"></script>

  <link rel="stylesheet" href="bootstrap.css" />






  <style>
    body {
      font-size: 11px;
      font-weight: 300;
      fill: #242424;
      text-align: center;
      text-shadow: 0 1px 0 #fff, 1px 0 0 #fff, -1px 0 0 #fff, 0 -1px 0 #fff;
      zoom: 100%;
      cursor: default;
    }

    .legend {

      fill: #333333;
    }

    .grid-container {
      display: inline-grid;
      /* grid-template-rows: 160px 160px; */
      grid-template-columns: 25% 25% 25% 25%;
    }

    h2 {
      margin-right: 25px;
    }

    .grid-container1 {

      grid-template-rows: 160px auto;

    }

    .line {
      fill: none;
      stroke: #ffab00;
      stroke-width: 3;
    }

    .center {
      text-align: center;
    }

    .grid-item1 {
      background-color: #2196F3;
      border: 1px solid rgba(0, 0, 0, 0.8);
      font-size: 30px;
      text-align: center;


    }

    .grid-item2 {
      background-color: #2196FF;
      border: 1px solid rgba(0, 0, 0, 0.8);
      font-size: 30px;
      text-align: center;
      height: 400px;

    }

    .states:hover {
      opacity: .6;
    }

    .a:hover {
      background: black;
    }

    .tooltip {
      position: absolute;
      text-align: center;
      padding: 2px;
      font: 12px sans-serif;
      pointer-events: none;
    }

    .titles {
      font-size: 15px;
      text-shadow: none;

      font-family: "Trebuchet MS";
    }

    #bigOne {
      font-size: 25px;
      font-weight: bold;
      text-align: center;
      line-height: 75px;
    }

    #selectFactor {
      font-size: 15px;
      /* width: 400px;
      margin: auto;
      align-content:center ;
      text-align: center; */
    }

    .butt {
      padding: 5px 5px;
      text-align: center;
      font-size: 12px;
      border: none;
      color: white;
      text-decoration: none;
      opacity: 0.5;
    }
    .tick{
      font: 9px sans-serif;
    }
    tspan{
      font: 9px sans-serif;
    }
    .textBottom{
      font: 9px sans-serif;
    }

    .textVertical{
      font: 9px sans-serif;
    }

    #indicator {
      background-color: transparent;
      color: black;
      border: none;
      padding-left: 0px;
      padding-bottom: 0px;
    }

    .inicio {
      padding-left: 0px;
    }

    .titlesGraph {
      background-color: rgb(0, 0, 0);
      opacity: 0.7;
      color: white;
      font-size: 15px;
      text-shadow: none;

      font-family: "Trebuchet MS";
    }
  </style>
</head>

<body>
  <div class="col-md-12 row">
    <div class="col-md-5 titles" id="bigOne">What makes us healthy?</div>
    <div class="col-md-7 inicio " style="margin-bottom: 10px; ">
      <div class="titlesGraph" id="selectFactor">Select a potential health factor</div>
      <div style="display: block;border:1px solid black">
        <text class="titlesGraph"></text>
        <div style="color: white; padding:9px;text-shadow:none">
          <button type="button" id="btnaverage_wages" class="butt btn-group si" value="average_wages"
            style="background-color:#1763A9">Average
            Wages</button>
          <button type="button" id="btnhours_worked" class="butt btn-group" value="hours_worked"
            style="background-color:#F67A27">Hours
            worked</button>
          <button type="button" id="btneducation" class="butt btn-group" value="education"
            style="background-color:#3BA257">Education</button>
          <button type="button" id="btnpollution" class="butt btn-group" value="pollution"
            style="background-color:#AE017E">Pollution</button>
          <button type="button" id="btngdp" class="butt btn-group" value="gdp"
            style="background-color:#D7301F">GDP</button>
          <button type="button" id="btnsocial_spending" class="butt btn-group" value="social_spending"
            style="background-color:#603E9A">Social
            spending</button>
          <button type="button" id="btnemployment_rate" class="butt btn-group" value="employment_rate"
            style="background-color:#9CD587">Employment rate</button>
          <button type="button" id="btnhappiness" class="butt btn-group" value="happiness"
            style="background-color:#E85EA6">Happiness</button>
        </div>
      </div>

    </div>
  </div>
  <div class="col-md-12 row">
    <div class=" col-md-5" id="map">
      <div style="border:1px solid black">
        <div class="titlesGraph" id="titleMap"></div>
        <div class="col-md-12">
          <svg id="my_dataviz" width="490" height="250"></svg>
        </div>
        <div  style="font: 9px sans-serif;" class="col-md-12">(scroll to zoom)</div>
        <div class="col-md-12" style="padding:0px">
          <text class= "col-md-2" id="numberMin" style="font: 9px sans-serif;"></text>
          <svg class= "col-md-8" id="colorScaleLegend" width="480" height="10" style="padding:0px;"></svg>
          <text class= "col-md-2" id="numberMax" style=" text-align: right; font: 9px sans-serif;"></text>
      </div>

      </div>
    </div>
    <div class="col-md-7 row" style="padding-right: 0px;">
      <div style="border:1px solid black; width:100%">
        <div class="titlesGraph" id="titleBoxPlot"></div>
        <div class="col-md-12 boxPlot"></div>
      </div>
      <div class="col-md-12" id="slider-time" style="padding:0px"></div>
    </div>

  </div>
  <div class="col-md-12 row">
    <div class="col-md-5">
      <div style="border:1px solid black;" width="822" height="384">
        <div class="titlesGraph" id="titleRadar"></div>
        <div class="radarChart"></div>
      </div>
    </div>
    <div class="col-md-7">
      <div style="border:1px solid black;padding:0px;">
        <div class="titlesGraph" id="titleScatter"></div>
        <svg class="col-md-3" id="the_chart0"></svg>
        <svg class="col-md-3" id="the_chart1"></svg>
        <svg class="col-md-3" id="the_chart2"></svg>
        <svg class="col-md-3" id="the_chart3"></svg>
        <svg class="col-md-4" id="the_chart4"></svg>
        <svg class="col-md-4" id="the_chart5"></svg>
        <svg class="col-md-4" id="the_chart6"></svg>
      </div>
    </div>
  </div>
  <script type="text/javascript">

    var files = ["HealthyData.json", "corre.json", "featuresMap.json"];
    var promises = [];
    var data = null;
    var selectedCircle;

    files.forEach(function (url) {
      promises.push(d3.json(url))
    });

    // Upload files
    Promise.all(promises).then(function (values) {
      var scatter = values[0];
      var correlation = values[1];
      var mapData = values[2].features;
      var mapDataDict = {};
      var countries = [];
      var countryCodes = {};
      for (var p = 0; p < mapData.length; p++) {
        countryCodes[mapData[p].id] = mapData[p]["properties"]["name"];
        countries.push(mapData[p].id);
        mapDataDict[mapData[p].id] = mapData[p];
      }
      


      var dispatch = d3.dispatch("timeEvent", "factorEvent", "eventMouseOver", "eventMouseOut", "selectCountry", "deSelectCountry");

      dict = {
        "Average Wages": "average_wages", "Hours worked": "hours_worked", "Education": "education", "Pollution": "pollution",
        "GDP": "gdp", "Social spending": "social_spending", "Employment rate": "employment_rate", "Happiness": "happiness"
      }
      dictUnit = {
        "Average Wages": "USD", "Hours worked": "hours/worker", "Education": "%", "Pollution": "&micro;g/m&#179;",
        "GDP": "USD/cap", "Social spending": "USD/cap", "Employment rate": "%", "Happiness": "in 10"
      }
      yearSelected = 2010;
      factorSelected = "average_wages";

      function getKeyByValue(object, value) {
        for (var key = 0; key < Object.keys(object).length; key++) {
          if (object[Object.keys(object)[key]] == value) {
            return Object.keys(object)[key];
          }
        }
      }

      var colors = {
        "average_wages": "#1763A9", "hours_worked": "#F67A27", "education": "#3BA257",
        "pollution": "#AE017E", "gdp": "#D7301F", "social_spending": "#603E9A",
        "employment_rate": "#9CD587", "happiness": "#E85EA6"
      }


      //draw graphics for the first time
      drawMap(scatter, yearSelected, factorSelected, true, colors[dict["Average Wages"]]);
      drawRadarChart(yearSelected, factorSelected, true, colors[dict["Average Wages"]]);


      // d3.selectAll("#circle0").attr("r",7);
      drawScatterPlot(scatter, yearSelected, factorSelected, true, colors[dict["Average Wages"]]);
      drawBoxPlot(scatter, yearSelected, factorSelected, true, colors[dict["Average Wages"]], null);


      ///////////////////////// TIME SLIDER /////////////////////////

      var dataTime = d3.range(0, 11).map(function (d) {
        return new Date(2007 + d, 10, 3);
      });
      var gTime = d3
        .select('#slider-time')
        .append('svg')
        .attr('width', 500)
        .attr('height', 75)
        .append('g')
        .attr('transform', 'translate(20,30)');

      //d3.select('p#value-time').text(d3.timeFormat('%Y')(sliderTime.value()));

      var sliderTime = d3
        .sliderBottom()
        .min(d3.min(dataTime))
        .max(d3.max(dataTime))
        .step(1000 * 60 * 60 * 24 * 365)
        .width(450)
        .height(75)
        .tickFormat(d3.timeFormat('%Y'))
        .tickValues(dataTime)
        .default(new Date(2010, 10, 3))
        .handle(
          d3.symbol()
            .type(d3.symbolCircle)
            .size(200))
        .on('onchange', val => {
          dispatch.call("timeEvent", this, d3.timeFormat('%Y')(val))
        });

      gTime.call(sliderTime);


      //TIME EVENT
      dispatch.on("timeEvent", function (time) {
        var dict = {
          "Average Wages": "average_wages", "Hours worked": "hours_worked", "Education": "education", "Pollution": "pollution",
          "GDP": "gdp", "Social spending": "social_spending", "Employment rate": "employment_rate", "Happiness": "happiness"
        }

        yearSelected = time;

        drawMap(scatter, yearSelected, factorSelected, false, colors[factorSelected]);
        drawRadarChart(yearSelected, factorSelected, false, colors[factorSelected]);
        drawScatterPlot(scatter, yearSelected, factorSelected, false, colors[factorSelected]);
        drawBoxPlot(scatter, yearSelected, factorSelected, false, colors[factorSelected], null);
      });

      d3.select("#btnaverage_wages").style("opacity", "1");

      //DROPDOWN
      d3.selectAll(".butt").on("click", function (d) {
        d3.selectAll(".butt").style("opacity", "0.5");
        d3.select(this).style("opacity", "1");
        console.log(this);
        factorSelected = this.value;
        console.log(factorSelected)
        drawMap(scatter, yearSelected, this.value, false, colors[factorSelected]);
        drawRadarChart(yearSelected, this.value, false, colors[factorSelected]);
        drawScatterPlot(scatter, yearSelected, this.value, false, colors[factorSelected]);
        drawBoxPlot(scatter, yearSelected, this.value, false, colors[factorSelected], null);
      });

      dispatch.on("selectCountry", function (value) {
        console.log(value);
        drawBoxPlot(scatter, yearSelected, factorSelected, false, colors[factorSelected], value);
      });

      dispatch.on("deSelectCountry", function () {
        console.log("d");
        d3.selectAll("#linePlot50").style("opacity", 0);
      });

      dispatch.on("eventMouseOver", function ([loc, k, colorLegend]) {
        
        if (loc == null) { //reta
          d3.select("#circle" + k)
          .transition()
          .duration(500)
          .attr("r", "6").style("fill-opacity", 1).style("fill", colors[factorSelected]).style("stroke-width", 1).style("stroke", "black");
          d3.select("#line" + k)
          // .transition()
          // .duration(500)
          .style("stroke-width", 3);
        } else {
          drawBoxPlot(scatter, yearSelected, factorSelected, false, colors[factorSelected], loc);
          d3.selectAll("[location=\"" + loc + "\"]")
          .transition()
          .duration(500)
          .attr("r", "5").style("opacity", 1).attr("stroke-width", 1).attr("stroke", "black");
          d3.selectAll(".Country")
            .transition()
            .duration(200)
            .style("opacity", .5);
          d3.select("#path_" + loc)
            .transition()
            .duration(200)
            .style("opacity", 1)
            .style("stroke", "black")
            .style("stroke-width", 1);
        }
        if (k != null) {
          // d3.select("#circle" + k).attr("r", "6").style("fill-opacity", 1).attr("stroke-width", 1).attr("stroke", "black");
          // d3.select(".radarCircle").attr("r",7);
        }
      });
      dispatch.on("eventMouseOut", function ([loc, k, colorLegend]) {
        if (loc == null) {
          d3.select("#circle" + k)
          .transition()
          .duration(500)
          .attr("r", "4").style("fill-opacity", 0.8).style("stroke-width", 0).style("stroke", "none");
          d3.select("#line" + k)
          .transition()
          .duration(500)
          .style("stroke-width", 1.5);
        }
        else {
          d3.selectAll("#linePlot50")
          .transition()
          .duration(500)
          .style("opacity", 0);

          d3.selectAll(".circleScatter")
          .transition()
          .duration(500)
          .attr("r", "2").style("opacity", 0.7).attr("stroke-width", 0).attr("stroke", "none");
          d3.selectAll(".Country")
            .transition()
            .duration(200)
            .style("opacity", .8)
            .style("stroke", "grey")
            .style("stroke-width", 0.25);
        }
        if (k != null) {
          console.log(k);
          // d3.select("#circle" + k).attr("r", "4").style("fill-opacity", 0.8).attr("stroke-width", 0).attr("stroke", "black");
        }

      });

      function drawMap(scatter, yearSelected, factorSelected, onCreate, colorLegend) {
        var dataMap = new Map();
        if(factorSelected == "average_wages"){
          d3.select("#titleMap").text("Average wages around the word");
        }
        else if(factorSelected == "hours_worked"){
          d3.select("#titleMap").text("Hours worked around the word");
        }
        else if(factorSelected == "education"){
          d3.select("#titleMap").text("People with upper education around the word");
        }
        else if(factorSelected == "pollution"){
          d3.select("#titleMap").text("Pollution around the word");
        }
        else if(factorSelected == "gdp"){
          d3.select("#titleMap").text("GDP around the word");
        }
        else if(factorSelected == "social_spending"){
          d3.select("#titleMap").text("Social spending around the world");
        }
        else if(factorSelected == "employment_rate"){
          d3.select("#titleMap").text("Employment rate worked around the word");
        }
        else{
          d3.select("#titleMap").text("Happiness worked around the word");
        }
        
        var dict = {
          "Average Wages": "average_wages", "Hours worked": "hours_worked", "Education": "education", "Pollution": "pollution",
          "GDP": "gdp", "Social spending": "social_spending", "Employment rate": "employment_rate", "Happiness": "happiness"
        }
        var max = 0;
        var min = 9999999999;
        var all = [];
        var mapDataCompleted = [];
        var maxPais = "";
        for (p = 0; p < scatter.length; p++) {
          var tempAll = {};
          tempAll = mapDataDict[scatter[p]["location"]];
          if (tempAll != undefined) {
            if (factorSelected != undefined) {
              tempAll["factorSelected"] = getKeyByValue(dict, factorSelected);
              tempAll["value"] = scatter[p][factorSelected];
              mapDataCompleted.push(tempAll);
            } else {
              tempAll["factorSelected"] = "";
              tempAll["value"] = "aaaa";
            }
          }

          if (scatter[p].time == yearSelected && scatter[p][factorSelected] != "") {
            if (scatter[p][factorSelected] - max > 0) {
              max = scatter[p][factorSelected];
              maxPais = scatter[p]["location"];
            }
            if (min > scatter[p][factorSelected]) {
              min = scatter[p][factorSelected];
            }
            dataMap.set(scatter[p].location, scatter[p][factorSelected]);
          }
        }
        
        var svg = d3.select("#my_dataviz"),
          width = +svg.attr("width"),
          height = +svg.attr("height");
        // svg.call(tipMap);
        // Map and projection
        var path = d3.geoPath();
        var projection = d3.geoMercator()
          .scale(70)
          .center([0, 20])
          .translate([width / 2, height / 1.8]);
        // Data and color scale
        var data = d3.map();
        var colorScaleBlue = d3.scaleThreshold()
          .domain([max / 9, max * 2 / 9, max * 3 / 9, max * 4 / 9, max * 5 / 9, max * 6 / 9, max * 7 / 9, max * 8 / 9, max])
          .range(d3.schemeBlues[9]);
        var colorScaleGrey = d3.scaleThreshold()
          .domain([max / 9, max * 2 / 9, max * 3 / 9, max * 4 / 9, max * 5 / 9, max * 6 / 9, max * 7 / 9, max * 8 / 9, max])
          .range(d3.schemeRdPu[9]);
        var colorScaleGreen = d3.scaleThreshold()
          .domain([max / 9, max * 2 / 9, max * 3 / 9, max * 4 / 9, max * 5 / 9, max * 6 / 9, max * 7 / 9, max * 8 / 9, max])
          .range(d3.schemeGreens[9]);
        var colorScalePurple = d3.scaleThreshold()
          .domain([max / 9, max * 2 / 9, max * 3 / 9, max * 4 / 9, max * 5 / 9, max * 6 / 9, max * 7 / 9, max * 8 / 9, max])
          .range(d3.schemePurples[9]);
        var colorScaleRed = d3.scaleThreshold()
          .domain([max / 9, max * 2 / 9, max * 3 / 9, max * 4 / 9, max * 5 / 9, max * 6 / 9, max * 7 / 9, max * 8 / 9, max])
          .range(d3.schemeYlGn[9]);
        var colorScaleOranges = d3.scaleThreshold()
          .domain([max / 9, max * 2 / 9, max * 3 / 9, max * 4 / 9, max * 5 / 9, max * 6 / 9, max * 7 / 9, max * 8 / 9, max])
          .range(d3.schemeOranges[9]);
        var colorScaleOrangeToRed = d3.scaleThreshold()
          .domain([max / 9, max * 2 / 9, max * 3 / 9, max * 4 / 9, max * 5 / 9, max * 6 / 9, max * 7 / 9, max * 8 / 9, max])
          .range(d3.schemeOrRd[9]);
        var colorScalePink = d3.scaleThreshold()
          .domain([max / 9, max * 2 / 9, max * 3 / 9, max * 4 / 9, max * 5 / 9, max * 6 / 9, max * 7 / 9, max * 8 / 9, max])
          .range(d3.schemePuRd[9]);


        var colorScale = colorScaleBlue;
        var interpolator = "interpolateBlues";
        if (factorSelected == "Hours worked" || colorLegend == "#F67A27") {
          colorScale = colorScaleOranges;
          interpolator = "interpolateOranges";
        } else if (factorSelected == "Education" || colorLegend == "#3BA257") {
          colorScale = colorScaleGreen;
          interpolator = "interpolateGreens"
        } else if (factorSelected == "Pollution" || colorLegend == "#AE017E") {
          colorScale = colorScaleGrey;
          interpolator = "interpolateRdPu";
        } else if (factorSelected == "GDP" || colorLegend == "#D7301F") {
          colorScale = colorScaleOrangeToRed;
          interpolator = "interpolateOrRd";
        } else if (factorSelected == "Social spending" || colorLegend == "#603E9A") {
          colorScale = colorScalePurple;
          interpolator = "interpolatePurples";
        } else if (factorSelected == "Employment rate" || colorLegend == "#9CD587") {
          colorScale = colorScaleRed;
          interpolator = "interpolateYlGn";
        } else if (factorSelected == "Happiness" || colorLegend == "#E85EA6") {
          colorScale = colorScalePink;
          interpolator = "interpolatePuRd";
        }

        
        var textMin =  min > 1000 ? (min/1000).toFixed(2) + "k" : min.toFixed(2);
        d3.select("#numberMin").text(textMin);

        var textMax =  max > 1000 ? (max/1000).toFixed(2) + "k" : max.toFixed(2);
        d3.select("#numberMax").html(textMax + " "+ dictUnit[getKeyByValue(dict, factorSelected)]);

        if (onCreate) {
          var svg1 = d3.select("#colorScaleLegend")
            .append("g");


          var colorScaleLegend = d3.scaleSequential(d3["interpolateBlues"])
            .domain([0, width]);

          var bars = svg1.selectAll(".bars")
            .data(d3.range(width), function (d) { return d; })
            .enter().append("rect")
            .attr("class", "bars")
            .attr("x", function (d, i) { return i; })
            .attr("y", 0)
            .attr("height", height)
            .attr("width", 1)
            .style("fill", function (d, i) { return colorScaleLegend(d); });
            

        }
        else {
          var colorScaleLegend = d3.scaleSequential(d3[interpolator])
            .domain([0, width]);
          d3.selectAll(".bars")
            .transition()
            .duration(500)
            .style("fill", function (d, i) { return colorScaleLegend(d); })
        }



        /////////////////////////////////////

        // Load external data and boot
        let mouseOver = function (d) {
          d3.selectAll(".Country")
            .transition()
            .duration(200)
            .style("opacity", .5)
          d3.select(this)
            .transition()
            .duration(200)
            .style("opacity", 1)
            .style("stroke", "black")
        }
        let mouseLeave = function (d) {
          d3.selectAll(".Country")
            .transition()
            .duration(200)
            .style("opacity", .8)
            .style("stroke", "grey")
          d3.select(this)
            .transition()
            .duration(200)
            .style("stroke", "grey")
        }
        var tipMapa = d3.select("body").append("div")
          .attr("class", "tooltip")
          .style("opacity", 0);
        if (onCreate) {
          console.log(all);
          // Draw the map
          svg.append("g")
            .attr("class", "gmap")
            .selectAll("path")
            .data(mapData)
            .enter()
            .append("path")
            // draw each country
            .attr("d", d3.geoPath()
              .projection(projection)
            )
            .attr("id", (d, i) => "path_" + d.id)
            // set the color of each country
            .attr("fill", function (d) {
              total = dataMap.get(d.id) || 0;
              return colorScale(total);
            })
            .style("stroke", "grey")
            .style("stroke-width", "0.25")
            .attr("class", "Country")
            .on("mouseover", function (d) {
              console.log(getKeyByValue(dict, factorSelected));
              tipMapa.transition()
                .duration(200)
                .style("opacity", 1);
              tipMapa.html(content = dataMap.get(d.id) ?
                "<span style=\"display: block;background-color: rgb(0,0,0); opacity:0.7;color: white; padding:9px;text-shadow:none; top:0px\">"
                + "<b>Location: </b>" + countryCodes[d.id] + "</br>"
                + "<b>" + getKeyByValue(dict, factorSelected) + ": </b>" + dataMap.get(d.id).toFixed(2) + " " + dictUnit[getKeyByValue(dict, factorSelected)] + "</span>"
                : "<span style=\"display: block;background-color: rgb(0,0,0); opacity:0.7;color: white; text-shadow:none; padding:9px; top:0px\">"
                + "<b>Location: </b>" + countryCodes[d.id] + "</br>"
                + "<b>N/A</b></span>")
                .style("left", (d3.event.pageX) + "px")
                .style("top", (d3.event.pageY - 28) + "px");
            })
            .on("mouseout", function (d) {
              tipMapa.transition()
                .duration(500)
                .style("opacity", 0);
            })
            .on("mouseover.path", (d, i) => {dispatch.call("eventMouseOver", this, [d.id, null, null] );  dispatch.call("selectCountry", this, d.id )})
            .on("mouseout.path", (d, i) => {dispatch.call("eventMouseOut", this, [d.id, null, null]); dispatch.call("deSelectCountry", this)})
          var zoom = d3.zoom()
            .scaleExtent([1, 10])
            .on('zoom', function () {
              d3.selectAll('.Country')
                .attr('transform', d3.event.transform);
            });

          svg.call(zoom);
        } else {
          for (var j = 0; j < countries.length; j++) {
            d3.select("#path_" + countries[j])
              .on("mouseover", function (d) {
                console.log(factorSelected);
                tipMapa.transition()
                  .duration(200)
                  .style("opacity", .9);
                tipMapa.html(content = dataMap.get(d.id) ? "<span style=\"display: block;background-color: rgb(0,0,0); opacity:0.7;color: white; padding:9px;text-shadow:none; top:0px\">"
                  + "<b>Location: </b>" + countryCodes[d.id] + "</br>"
                  + "<b>" + getKeyByValue(dict, factorSelected) + ": </b>" + dataMap.get(d.id).toFixed(2) + " " + dictUnit[getKeyByValue(dict, factorSelected)] + "</span>"
                  : "<span style=\"display: block;background-color: rgb(0,0,0); opacity:0.7;color: white; text-shadow:none; padding:9px; top:0px\">"
                  + "<b>Location: </b>" + countryCodes[d.id] + "</br>"
                  + "<b>N/A</b></span>")
                  .style("left", (d3.event.pageX) + "px")
                  .style("top", (d3.event.pageY - 28) + "px");
              })
              .on("mouseout", function (d) {
                tipMapa.transition()
                  .duration(500)
                  .style("opacity", 0);
              })
              .transition()
              .duration(500)
              // set the color of each country
              .attr("fill", function (d) {
                total = dataMap.get(d.id) || 0;
                return colorScale(total);
              });
          }
        }

      }

      function drawRadarChart(time, event, onCreate, colorLegend) {
        if(factorSelected == "average_wages"){
          d3.select("#titleRadar").text("Correlation between average wages and health factors");
        }
        else if(factorSelected == "hours_worked"){
          d3.select("#titleRadar").text("Correlation between hours worked and health factors");
        }
        else if(factorSelected == "education"){
          d3.select("#titleRadar").text("Correlation between people with upper education and health factors");
        }
        else if(factorSelected == "pollution"){
          d3.select("#titleRadar").text("Correlation between pollution and health factors");
        }
        else if(factorSelected == "gdp"){
          d3.select("#titleRadar").text("Correlation between GDP and health factors");
        }
        else if(factorSelected == "social_spending"){
          d3.select("#titleRadar").text("Correlation between social spending and health factors");
        }
        else if(factorSelected == "employment_rate"){
          d3.select("#titleRadar").text("Correlation between employment rate and health factors");
        }
        else{
          d3.select("#titleRadar").text("Correlation between happiness and health factors");
        }
        

        arrayCorrelation = [];
        for (var i = 0; i < correlation.length; i++) {
          if (correlation[i].Time == time && correlation[i].Var == getKeyByValue(dict, event)) {
            arrayCorrelation.push(correlation[i].Alcohol, correlation[i].Smokers, correlation[i].Cancer, correlation[i].Suicide, correlation[i].LifeAtOld, correlation[i].LifeAtBirth, correlation[i].Obese, correlation[i].Happiness);
          }
        }
        var data = [
          {
            name: 'Correlation ',
            axes: [
              { axis: 'Alcohol', value: arrayCorrelation[0] },
              { axis: 'Obese', value: arrayCorrelation[1] },
              { axis: 'Smokers', value: arrayCorrelation[2] },
              { axis: 'Life expectancy at birth', value: arrayCorrelation[3] },
              { axis: 'Life expectancy at 65', value: arrayCorrelation[4] },
              { axis: 'Suicide rate', value: arrayCorrelation[5] },
              { axis: 'Deaths by cancer', value: arrayCorrelation[6] }
            ]
          }
        ];
        var margin = { top: 100, right: 50, bottom: 90, left: 30 },
          width = Math.min(700, window.innerWidth / 4) - margin.left - margin.right,
          height = Math.min(width, window.innerHeight - margin.top - margin.bottom);
        var radarChartOptions = {
          w: 150,
          h: 170,
          margin: margin,
          maxValue: 1,
          levels: 5,
          roundStrokes: false,
          color: colorLegend,
          format: '.2'
        };

        var tip7 = d3.select("body").append("div")
          .attr("class", "tooltip")
          .style("opacity", 0);


        const parent = d3.select(".radarChart");
        let svgRADAR = parent.select("svg");

        if (onCreate) {
          //Initiate the radar chart SVG
          svgRADAR = parent.append("svg")
            .attr("width", radarChartOptions.w + radarChartOptions.margin.left / 2 + radarChartOptions.margin.right)
            .attr("height", radarChartOptions.h + radarChartOptions.margin.top + radarChartOptions.margin.bottom)
            .attr("class", "radar")
            .attr("width", 250);
        }
        let svg_radar1 = RadarChart(".radarChart", data, radarChartOptions, tip7, onCreate, svgRADAR, colorLegend);
      }


      function drawScatterPlot(dataset, selectedYear, factorSelected, onCreate, colorLegend) {
        if(factorSelected == "average_wages"){
          d3.select("#titleScatter").text("Distribuition of different health factors by average wages");
        }
        else if(factorSelected == "hours_worked"){
          d3.select("#titleScatter").text("Distribuition of different health factors by hours worked");
        }
        else if(factorSelected == "education"){
          d3.select("#titleScatter").text(" Distribuition of different health factors by people with upper education");
        }
        else if(factorSelected == "pollution"){
          d3.select("#titleScatter").text("Distribuition of different health factors by pollution");
        }
        else if(factorSelected == "gdp"){
          d3.select("#titleScatter").text("Distribuition of different health factors by GDP");
        }
        else if(factorSelected == "social_spending"){
          d3.select("#titleScatter").text("Distribuition of different health factors by social spending");
        }
        else if(factorSelected == "employment_rate"){
          d3.select("#titleScatter").text("Distribuition of different health factors by employment rate");
        }
        else{
          d3.select("#titleScatter").text("Distribuition of different health factors by happiness");
        }
        var w = 180;
        var h = 180;
        var padding = 32;
        var bar_w = 0;
        var r = 2;

        var healthList = [
          { title: 'Obese', value: "obese" },
          { title: 'Alcohol', value: "alcohol" },
          { title: 'Smokers', value: "smokers" },
          { title: 'Life expectancy at birth', value: "life_at_birth" },
          { title: 'Life expectancy at 65', value: "life_at_old" },
          { title: 'Suicide rate', value: "suicide" },
          { title: 'Deaths by cancer', value: "cancer" },
        ]

        var tipObese = d3.select("body").append("div")
          .attr("class", "tooltip")
          .style("opacity", 0);
        var tipAlcohol = d3.select("body").append("div")
          .attr("class", "tooltip")
          .style("opacity", 0);
        var tipSmokers = d3.select("body").append("div")
          .attr("class", "tooltip")
          .style("opacity", 0);
        var tipLifeAtBirth = d3.select("body").append("div")
          .attr("class", "tooltip")
          .style("opacity", 0);
        var tipLifeAtOld = d3.select("body").append("div")
          .attr("class", "tooltip")
          .style("opacity", 0);
        var tipSuicide = d3.select("body").append("div")
          .attr("class", "tooltip")
          .style("opacity", 0);
        var tipCancer = d3.select("body").append("div")
          .attr("class", "tooltip")
          .style("opacity", 0);
        var tipObeseC = d3.select("body").append("div")
          .attr("class", "tooltip")
          .style("opacity", 0);
        var tipAlcoholC = d3.select("body").append("div")
          .attr("class", "tooltip")
          .style("opacity", 0);
        var tipSmokersC = d3.select("body").append("div")
          .attr("class", "tooltip")
          .style("opacity", 0);
        var tipLifeAtBirthC = d3.select("body").append("div")
          .attr("class", "tooltip")
          .style("opacity", 0);
        var tipLifeAtOldC = d3.select("body").append("div")
          .attr("class", "tooltip")
          .style("opacity", 0);
        var tipSuicideC = d3.select("body").append("div")
          .attr("class", "tooltip")
          .style("opacity", 0);
        var tipCancerC = d3.select("body").append("div")
          .attr("class", "tooltip")
          .style("opacity", 0);

     
        for (var k = 0; k < healthList.length; k++) {
          var svg = onCreate ? d3.select("#the_chart" + k)
            .attr("width", w)
            .attr("height", h)
            .attr("class", "_" + healthList[k].value)
            .attr("fill", colorLegend) : d3.select("#the_chart" + k);

          var hscale = d3.scaleLinear()
            .domain([d3.max(dataset, function (d) {

              return parseInt(d[healthList[k].value]);
            }), d3.min(dataset, function (d) {
              return parseInt(d[healthList[k].value]);
            })])
            .range([padding, h - padding]);

          var xscale = d3.scaleLinear()
            .domain([d3.min(dataset, function (d) {
              return parseInt(d[factorSelected]);
            }), d3.max(dataset, function (d) {
              return parseInt(d[factorSelected]);
            })])
            .range([padding, w - padding]);

          var yaxis = d3.axisLeft()
            .scale(hscale)
            .ticks(3);


          var xaxis = d3.axisBottom()
            .scale(xscale)
            .ticks(3) 
            .tickFormat(d => d > 1000 ? (d/1000)+"k": d);
          //.ticks(dataset.length/2);
          var cscale = d3.scaleLinear()
            .domain([d3.min(dataset, function (d) { return d[factorSelected]; }),
            d3.max(dataset, function (d) { return d[factorSelected]; })])
            .range(["red", colorLegend]);




          if (onCreate) {

            gY = svg.append("g")
              .attr("transform", "translate(30,0)")
              .attr("class", "y_axis")
              .call(yaxis);


            gX = svg.append("g")
              .attr("class", "x_axis")
              .attr("transform", "translate(0," + (h - padding) + ")")
              .call(xaxis);
          } else {
           
            gX = d3.selectAll(".x_axis")
              .transition()
              .duration(500)
              .attr("transform", "translate(0," + (h - padding) + ")")
              .call(xaxis);
          }
          svg.selectAll(".xaxis text")  // select all the text elements for the xaxis
            .attr("fill", "blue")
            .attr("transform", function (d) {

              return "translate(" + this.getBBox().h * -2 + "," + this.getBBox().h + ")rotate(-45)";
            });

          if (onCreate) {
            

            svg.append("text")
            .attr("class", "textVertical")
              .attr("fill", "black")
              .attr("text-anchor", "middle")  // this makes it easy to centre the text as the transform is applied to the anchor
              .attr("transform", "translate(" + (7) + "," + (h/2) + ") rotate(270)")  // text is drawn off the screen top left, move down and out and rotate
              .text(healthList[k].title);

              svg.append("text")
              .attr("class", "textBottom")
                .attr("fill", "black")
                  .attr("text-anchor", "middle")  // this makes it easy to centre the text as the transform is applied to the anchor
                  .attr("transform", "translate(" + (w/2) + "," + (h ) + ")")  // text is drawn off the screen top left, move down and out and rotate
                  .text(getKeyByValue(dict, factorSelected));


          }
          arrayCorrelation = [];
                for (var i = 0; i < correlation.length; i++) {
                    if (correlation[i].Time == yearSelected && correlation[i].Var == getKeyByValue(dict, factorSelected)) {
                      arrayCorrelation.push(correlation[i].Alcohol, correlation[i].Smokers, correlation[i].Cancer, correlation[i].Suicide, correlation[i].LifeAtOld, correlation[i].LifeAtBirth, correlation[i].Obese, correlation[i].Happiness);
                    }
                  }
          if (onCreate) {
            if (healthList[k].value == "obese") {
             

              svg.selectAll(".circleScatter")
                .data(dataset.filter(function (d) { return d.time == selectedYear; }).filter(function (d) { return d[factorSelected] != ""; }).filter(function (d) { return d[healthList[k].value] != ""; }))
                .enter().append("circle")
                .style("opacity", 0.7)
                .on("mouseover.circle", function (d, i) {
                  dispatch.call("eventMouseOver", this, [d3.select(this).attr("location"), 1, colorLegend]);
                })
                .on("mouseout.circle", function (d, i) {
                  dispatch.call("eventMouseOut", this, [d3.select(this).attr("location"), 1, colorLegend]);
                })
                .on("mouseover", function (d) {
                  tipObese.transition()
                    .duration(200)
                    .style("opacity", 1);
                    var dd = d[factorSelected] > 1000 ? (d[factorSelected]/1000).toFixed(2) + "k" : d[factorSelected].toFixed(2);
                  tipObese.html(content = "<span style=\"display: block;background-color: rgb(0,0,0); opacity:0.7;color: white; text-shadow:none; padding:9px; top:0px\">" +
                    "<b>Location: </b>" + countryCodes[d.location] + "</br>" +
                    "<b>Obese: </b>" + d["obese"] + " % </br>" +
                    "<b>" + getKeyByValue(dict, factorSelected) + "</b>: " + dd + " " + dictUnit[getKeyByValue(dict, factorSelected)]+ "</br>" +
                    "</span>")
                    .style("left", (d3.event.pageX) + "px")
                    .style("top", (d3.event.pageY - 28) + "px");
                })
                .on("mouseout", function (d) {
                  tipObese.transition()
                    .duration(500)
                    .style("opacity", 0);
                })
                .attr("r", r)
                .attr("class", "circleScatter " + healthList[k].value)
                .attr("fill", colorLegend)
                .attr("id", (d, i) => "scatter_" + i)
                .attr("cx", function (d, i) {
                  //if (d[factorSelected] != 0 && d[healthList[k].value] != 0 && d.time == selectedYear) { 
                  return xscale(d[factorSelected]);
                })
                .attr("cy", function (d) {
                  return hscale(d[healthList[k].value]);
                })
                .attr("location", function (d) { return d.location; });

               
              var lineValues = create_data(healthList[k].value);
              d3.select("._obese").append("line")
                .attr("stroke", colorLegend)
                .attr("class", "corrLine")
                .attr("id", "line1")
                .attr("stroke-width", 1.5)
                .attr("x1", lineValues[0]["x"])
                .attr("y1", lineValues[0]["yhat"])
                .attr("x2", lineValues[1]["x"])
                .attr("y2", lineValues[1]["yhat"])
                .on("mouseover", function (d) {
                  dispatch.call("eventMouseOver", this, [null, 1, colorLegend]);
                  tipObeseC.transition()
                    .duration(200)
                    .style("opacity", 1);
                  tipObeseC.html(content = "<span style=\"display: block;background-color: rgb(0,0,0); opacity:0.7;color: white; text-shadow:none; padding:9px; top:0px\">" +
                    "<b>Correlation: </b>" + arrayCorrelation[1].toFixed(3) + "</span>")
                    .style("left", (d3.event.pageX) + "px")
                    .style("top", (d3.event.pageY - 28) + "px");
                })
                .on("mouseout", function (d) {
                  dispatch.call("eventMouseOut", this, [null, 1, colorLegend]);
                  tipObeseC.transition()
                    .duration(500)
                    .style("opacity", 0);
                });
            }
            else if (healthList[k].value == "alcohol") {
              svg.selectAll(".circleScatter")
                .data(dataset.filter(function (d) { return d.time == selectedYear; }).filter(function (d) { return d[factorSelected] != ""; }).filter(function (d) { return d[healthList[k].value] != ""; }))
                .enter().append("circle")
                .style("opacity", 0.7)
                .on("mouseover.circle", function (d, i) {
                  dispatch.call("eventMouseOver", this, [d3.select(this).attr("location"), 0, colorLegend]);
                })
                .on("mouseout.circle", function (d, i) {
                  dispatch.call("eventMouseOut", this, [d3.select(this).attr("location"), 0, colorLegend]);
                })
                .on("mouseover", function (d) {
                  tipAlcohol.transition()
                    .duration(200)
                    .style("opacity", 1);
                    var dd = d[factorSelected] > 1000 ? (d[factorSelected]/1000).toFixed(2) + "k" : d[factorSelected].toFixed(2);
                    
                    tipAlcohol.html(content = "<span style=\"display: block;background-color: rgb(0,0,0); opacity:0.7;color: white; text-shadow:none; padding:9px; top:0px\">" +
                      "<b>Location: </b>" + countryCodes[d.location] + "</br>" +
                      "<b>Alcohol: </b>" + d["alcohol"] + " lt/cap </br>" +
                      "<b>" + getKeyByValue(dict, factorSelected) + "</b>: " + dd + " " + dictUnit[getKeyByValue(dict, factorSelected)]+ "</br>" +

                    "</span>")
                    .style("left", (d3.event.pageX) + "px")
                    .style("top", (d3.event.pageY - 28) + "px");
                })
                .on("mouseout", function (d) {
                  tipAlcohol.transition()
                    .duration(500)
                    .style("opacity", 0);
                })
                .attr("r", r)
                .attr("class", "circleScatter " + healthList[k].value)
                .attr("fill", colorLegend)
                .attr("id", (d, i) => "scatter_" + i)
                .attr("cx", function (d, i) {
                  //if (d[factorSelected] != 0 && d[healthList[k].value] != 0 && d.time == selectedYear) { 
                  return xscale(d[factorSelected]);
                })
                .attr("cy", function (d) {
                  return hscale(d[healthList[k].value]);
                })
                .attr("location", function (d) { return d.location; });

              var lineValues = create_data(healthList[k].value);
              d3.select("._alcohol").append("line")
                .attr("stroke", colorLegend)
                .attr("class", "corrLine")
                .attr("id", "line0")
                .attr("stroke-width", 1.5)
                .attr("x1", lineValues[0]["x"])
                .attr("y1", lineValues[0]["yhat"])
                .attr("x2", lineValues[1]["x"])
                .attr("y2", lineValues[1]["yhat"])
                .on("mouseover", function (d) {
                  dispatch.call("eventMouseOver", this, [null, 0, colorLegend]);
                  tipObeseC.transition()
                    .duration(200)
                    .style("opacity", 1);
                  tipObeseC.html(content = "<span style=\"display: block;background-color: rgb(0,0,0); opacity:0.7;color: white; text-shadow:none; padding:9px; top:0px\">" +
                    "<b>Correlation: </b>" + arrayCorrelation[0].toFixed(3) + "</span>")
                    .style("left", (d3.event.pageX) + "px")
                    .style("top", (d3.event.pageY - 28) + "px");
                })
                .on("mouseout", function (d) {
                  dispatch.call("eventMouseOut", this, [null, 0, colorLegend]);
                  tipObeseC.transition()
                    .duration(500)
                    .style("opacity", 0);
                });
            }
            else if (healthList[k].value == "smokers") {
              svg.selectAll(".circleScatter")
                .data(dataset.filter(function (d) { return d.time == selectedYear; }).filter(function (d) { return d[factorSelected] != ""; }).filter(function (d) { return d[healthList[k].value] != ""; }))
                .enter().append("circle")
                .style("opacity", 0.7)
                .on("mouseover.circle", function (d, i) {
                  dispatch.call("eventMouseOver", this, [d3.select(this).attr("location"), 2, colorLegend]);
                })
                .on("mouseout.circle", function (d, i) {
                  dispatch.call("eventMouseOut", this, [d3.select(this).attr("location"), 2, colorLegend]);
                })
                .on("mouseover", function (d) {
                  tipSmokers.transition()
                    .duration(200)
                    .style("opacity", 1);
                    var dd = d[factorSelected] > 1000 ? (d[factorSelected]/1000).toFixed(2) + "k" : d[factorSelected].toFixed(2);
                    
                    tipSmokers.html(content = "<span style=\"display: block;background-color: rgb(0,0,0); opacity:0.7;color: white; text-shadow:none; padding:9px; top:0px\">" +
                      "<b>Location: </b>" + countryCodes[d.location] + "</br>" +
                      "<b>Smokers: </b>" + d["smokers"] + " % </br>" +
                      "<b>" + getKeyByValue(dict, factorSelected) + "</b>: " + dd + " " + dictUnit[getKeyByValue(dict, factorSelected)]+ "</br>" +
                    "</span>")
                    .style("left", (d3.event.pageX) + "px")
                    .style("top", (d3.event.pageY - 28) + "px");
                })
                .on("mouseout", function (d) {
                  tipSmokers.transition()
                    .duration(500)
                    .style("opacity", 0);
                })
                .attr("r", r)
                .attr("class", "circleScatter " + healthList[k].value)
                .attr("fill", colorLegend)
                .attr("id", (d, i) => "scatter_" + i)
                .attr("cx", function (d, i) {
                  //if (d[factorSelected] != 0 && d[healthList[k].value] != 0 && d.time == selectedYear) { 
                  return xscale(d[factorSelected]);
                })
                .attr("cy", function (d) {
                  return hscale(d[healthList[k].value]);
                })
                .attr("location", function (d) { return d.location; });

              var lineValues = create_data(healthList[k].value);
              d3.select("._smokers").append("line")
                .attr("stroke", colorLegend)
                .attr("class", "corrLine")
                .attr("id", "line2")
                .attr("stroke-width", 1.5)
                .attr("x1", lineValues[0]["x"])
                .attr("y1", lineValues[0]["yhat"])
                .attr("x2", lineValues[1]["x"])
                .attr("y2", lineValues[1]["yhat"])
                .on("mouseover", function (d) {
                  dispatch.call("eventMouseOver", this, [null, 2, colorLegend]);
                  tipSmokersC.transition()
                    .duration(200)
                    .style("opacity", 1);
                    tipSmokersC.html(content = "<span style=\"display: block;background-color: rgb(0,0,0); opacity:0.7;color: white; text-shadow:none; padding:9px; top:0px\">" +
                    "<b>Correlation: </b>" + arrayCorrelation[2].toFixed(3) + "</span>")
                    .style("left", (d3.event.pageX) + "px")
                    .style("top", (d3.event.pageY - 28) + "px");
                })
                .on("mouseout", function (d) {
                  dispatch.call("eventMouseOut", this, [null, 2, colorLegend]);
                  tipSmokersC.transition()
                    .duration(500)
                    .style("opacity", 0);
                });
            }
            else if (healthList[k].value == "life_at_birth") {
              svg.selectAll(".circleScatter")
                .data(dataset.filter(function (d) { return d.time == selectedYear; }).filter(function (d) { return d[factorSelected] != ""; }).filter(function (d) { return d[healthList[k].value] != ""; }))
                .enter().append("circle")
                .style("opacity", 0.7)
                .on("mouseover.circle", function (d, i) {
                  dispatch.call("eventMouseOver", this, [d3.select(this).attr("location"), 3, colorLegend]);
                })
                .on("mouseout.circle", function (d, i) {
                  dispatch.call("eventMouseOut", this, [d3.select(this).attr("location"), 3, colorLegend]);
                })
                .on("mouseover", function (d) {
                  tipLifeAtBirth.transition()
                    .duration(200)
                    .style("opacity", 1);
                    var dd = d[factorSelected] > 1000 ? (d[factorSelected]/1000).toFixed(2) + "k" : d[factorSelected].toFixed(2);
                    
                    tipLifeAtBirth.html(content = "<span style=\"display: block;background-color: rgb(0,0,0); opacity:0.7;color: white; padding:9px;text-shadow:none; top:0px\">"
                      + "<b>Location: </b>" + countryCodes[d.location] + "</br>" +
                      "<b>Life at birth: </b>" + d["life_at_birth"] + " years </br>" +
                      "<b>" + getKeyByValue(dict, factorSelected) + "</b>: " + dd + " " + dictUnit[getKeyByValue(dict, factorSelected)]+ "</br>" + "</span>")
                    .style("left", (d3.event.pageX) + "px")
                    .style("top", (d3.event.pageY - 28) + "px");
                })
                .on("mouseout", function (d) {
                  tipLifeAtBirth.transition()
                    .duration(500)
                    .style("opacity", 0);
                })
                .attr("r", r)
                .attr("class", "circleScatter " + healthList[k].value)
                .attr("fill", colorLegend)
                .attr("id", (d, i) => "scatter_" + i)
                .attr("cx", function (d, i) {
                  //if (d[factorSelected] != 0 && d[healthList[k].value] != 0 && d.time == selectedYear) { 
                  return xscale(d[factorSelected]);
                })
                .attr("cy", function (d) {
                  return hscale(d[healthList[k].value]);
                })
                .attr("location", function (d) { return d.location; });

              var lineValues = create_data(healthList[k].value);
              d3.select("._life_at_birth").append("line")
                .attr("stroke", colorLegend)
                .attr("class", "corrLine")
                .attr("id", "line3")
                .attr("stroke-width", 1.5)
                .attr("x1", lineValues[0]["x"])
                .attr("y1", lineValues[0]["yhat"])
                .attr("x2", lineValues[1]["x"])
                .attr("y2", lineValues[1]["yhat"])
                .on("mouseover", function (d) {
                  dispatch.call("eventMouseOver", this, [null, 3, colorLegend]);
                  tipLifeAtBirthC.transition()
                    .duration(200)
                    .style("opacity", 1);
                    tipLifeAtBirthC.html(content = "<span style=\"display: block;background-color: rgb(0,0,0); opacity:0.7;color: white; text-shadow:none; padding:9px; top:0px\">" +
                    "<b>Correlation: </b>" + arrayCorrelation[3].toFixed(3) + "</span>")
                    .style("left", (d3.event.pageX) + "px")
                    .style("top", (d3.event.pageY - 28) + "px");
                })
                .on("mouseout", function (d) {
                  dispatch.call("eventMouseOut", this, [null, 3, colorLegend]);
                  tipLifeAtBirthC.transition()
                    .duration(500)
                    .style("opacity", 0);
                });
            }
            else if (healthList[k].value == "life_at_old") {
              svg.selectAll(".circleScatter")
                .data(dataset.filter(function (d) { return d.time == selectedYear; }).filter(function (d) { return d[factorSelected] != ""; }).filter(function (d) { return d[healthList[k].value] != ""; }))
                .enter().append("circle")
                .style("opacity", 0.7)
                .on("mouseover.circle", function (d, i) {
                  dispatch.call("eventMouseOver", this, [d3.select(this).attr("location"), 4, colorLegend]);
                })
                .on("mouseout.circle", function (d, i) {
                  dispatch.call("eventMouseOut", this, [d3.select(this).attr("location"), 4, colorLegend]);
                })
                .on("mouseover", function (d) {
                  tipLifeAtOld.transition()
                    .duration(200)
                    .style("opacity", 1);
                    var dd = d[factorSelected] > 1000 ? (d[factorSelected]/1000).toFixed(2) + "k" : d[factorSelected].toFixed(2);
                    
                    tipLifeAtOld.html(content = "<span style=\"display: block;background-color: rgb(0,0,0); opacity:0.7;color: white; padding:9px;text-shadow:none; top:0px\">"
                      + "<b>Location: </b>" + countryCodes[d.location] + "</br>" +
                      "<b>Life at old: </b>" + d["life_at_old"] + " years </br>" +
                      "<b>" + getKeyByValue(dict, factorSelected) + "</b>: " + dd + " " + dictUnit[getKeyByValue(dict, factorSelected)]+ "</br>" +
                    "</span>")
                    .style("left", (d3.event.pageX) + "px")
                    .style("top", (d3.event.pageY - 28) + "px");
                })
                .on("mouseout", function (d) {
                  tipLifeAtOld.transition()
                    .duration(500)
                    .style("opacity", 0);
                })
                .attr("r", r)
                .attr("class", "circleScatter " + healthList[k].value)
                .attr("fill", colorLegend)
                .attr("id", (d, i) => "scatter_" + i)
                .attr("cx", function (d, i) {
                  //if (d[factorSelected] != 0 && d[healthList[k].value] != 0 && d.time == selectedYear) { 
                  return xscale(d[factorSelected]);
                })
                .attr("cy", function (d) {
                  return hscale(d[healthList[k].value]);
                })
                .attr("location", function (d) { return d.location; });

              var lineValues = create_data(healthList[k].value);
              d3.select("._life_at_old").append("line")
                .attr("stroke", colorLegend)
                .attr("class", "corrLine")
                .attr("id", "line4")
                .attr("stroke-width", 1.5)
                .attr("x1", lineValues[0]["x"])
                .attr("y1", lineValues[0]["yhat"])
                .attr("x2", lineValues[1]["x"])
                .attr("y2", lineValues[1]["yhat"])
                .on("mouseover", function (d) {
                  dispatch.call("eventMouseOver", this, [null, 4, colorLegend]);
                  tipLifeAtOldC.transition()
                    .duration(200)
                    .style("opacity", 1);
                    tipLifeAtOldC.html(content = "<span style=\"display: block;background-color: rgb(0,0,0); opacity:0.7;color: white; text-shadow:none; padding:9px; top:0px\">" +
                    "<b>Correlation: </b>" + arrayCorrelation[4].toFixed(3) + "</span>")
                    .style("left", (d3.event.pageX) + "px")
                    .style("top", (d3.event.pageY - 28) + "px");
                })
                .on("mouseout", function (d) {
                  dispatch.call("eventMouseOut", this, [null, 4, colorLegend]);
                  tipLifeAtOldC.transition()
                    .duration(500)
                    .style("opacity", 0);
                });
            }
            else if (healthList[k].value == "suicide") {
              svg.selectAll(".circleScatter")
                .data(dataset.filter(function (d) { return d.time == selectedYear; }).filter(function (d) { return d[factorSelected] != ""; }).filter(function (d) { return d[healthList[k].value] != ""; }))
                .enter().append("circle")
                .style("opacity", 0.7)
                .on("mouseover.circle", function (d, i) {
                  dispatch.call("eventMouseOver", this, [d3.select(this).attr("location"), 5, colorLegend]);
                })
                .on("mouseout.circle", function (d, i) {
                  dispatch.call("eventMouseOut", this, [d3.select(this).attr("location"), 5, colorLegend]);
                })
                .on("mouseover", function (d) {
                  tipSuicide.transition()
                    .duration(200)
                    .style("opacity", 1);
                    var dd = d[factorSelected] > 1000 ? (d[factorSelected]/1000).toFixed(2) + "k" : d[factorSelected].toFixed(2);
                    
                    tipSuicide.html(content = "<span style=\"display: block;background-color: rgb(0,0,0); opacity:0.7;color: white; padding:9px;text-shadow:none; top:0px\">"
                      + "<b>Location: </b>" + countryCodes[d.location] + "</br>" +
                      "<b>Suicide: </b>" + d["suicide"] + " per 100 000 persons</br>" +
                      "<b>" + getKeyByValue(dict, factorSelected) + "</b>: " + dd + " " + dictUnit[getKeyByValue(dict, factorSelected)]+ "</br>" +
                     "</span>")
                    .style("left", (d3.event.pageX) + "px")
                    .style("top", (d3.event.pageY - 28) + "px");
                })
                .on("mouseout", function (d) {
                  tipSuicide.transition()
                    .duration(500)
                    .style("opacity", 0);
                })
                .attr("r", r)
                .attr("class", "circleScatter " + healthList[k].value)
                .attr("fill", colorLegend)
                .attr("id", (d, i) => "scatter_" + i)
                .attr("cx", function (d, i) {
                  //if (d[factorSelected] != 0 && d[healthList[k].value] != 0 && d.time == selectedYear) { 
                  return xscale(d[factorSelected]);
                })
                .attr("cy", function (d) {
                  return hscale(d[healthList[k].value]);
                })
                .attr("location", function (d) { return d.location; });
              var lineValues = create_data(healthList[k].value);
              d3.select("._suicide").append("line")
                .attr("stroke", colorLegend)
                .attr("class", "corrLine")
                .attr("id", "line5")
                .attr("stroke-width", 1.5)
                .attr("x1", lineValues[0]["x"])
                .attr("y1", lineValues[0]["yhat"])
                .attr("x2", lineValues[1]["x"])
                .attr("y2", lineValues[1]["yhat"])
                .on("mouseover", function (d) {
                  dispatch.call("eventMouseOver", this, [null, 5, colorLegend]);
                  tipSuicideC.transition()
                    .duration(200)
                    .style("opacity", 1);
                    tipSuicideC.html(content = "<span style=\"display: block;background-color: rgb(0,0,0); opacity:0.7;color: white; text-shadow:none; padding:9px; top:0px\">" +
                    "<b>Correlation: </b>" + arrayCorrelation[5].toFixed(3) + "</span>")
                    .style("left", (d3.event.pageX) + "px")
                    .style("top", (d3.event.pageY - 28) + "px");
                })
                .on("mouseout", function (d) {
                  dispatch.call("eventMouseOut", this, [null, 5, colorLegend]);
                  tipSuicideC.transition()
                    .duration(500)
                    .style("opacity", 0);
                });
            }
            else if (healthList[k].value == "cancer") {
              svg.selectAll(".circleScatter")
                .data(dataset.filter(function (d) { return d.time == selectedYear; }).filter(function (d) { return d[factorSelected] != ""; }).filter(function (d) { return d[healthList[k].value] != ""; }))
                .enter().append("circle")
                .style("opacity", 0.7)
                .on("mouseover.circle", function (d, i) {
                  dispatch.call("eventMouseOver", this, [d3.select(this).attr("location"), 6, colorLegend]);
                })
                .on("mouseout.circle", function (d, i) {
                  dispatch.call("eventMouseOut", this, [d3.select(this).attr("location"), 6, colorLegend]);
                })
                .on("mouseover", function (d) {
                  tipCancer.transition()
                    .duration(200)
                    .style("opacity", 1);
                    var dd = d[factorSelected] > 1000 ? (d[factorSelected]/1000).toFixed(2) + "k" : d[factorSelected].toFixed(2);
                    
                    tipCancer.html(content = "<span style=\"display: block;background-color: rgb(0,0,0); opacity:0.7;color: white; padding:9px;text-shadow:none; top:0px\">"
                      + "<b>Location: </b>" + countryCodes[d.location] + "</br>" +
                      "<b>Cancer: </b>" + d["cancer"] + " per 100 000 persons </br>" +
                      "<b>" + getKeyByValue(dict, factorSelected) + "</b>: " + dd + " " + dictUnit[getKeyByValue(dict, factorSelected)]+ "</br>" +
                       "</span>")
                    .style("left", (d3.event.pageX) + "px")
                    .style("top", (d3.event.pageY - 28) + "px");
                })
                .on("mouseout", function (d) {
                  tipCancer.transition()
                    .duration(500)
                    .style("opacity", 0);
                })
                .attr("r", r)
                .attr("class", "circleScatter " + healthList[k].value)
                .attr("fill", colorLegend)
                .attr("id", (d, i) => "scatter_" + i)
                .attr("cx", function (d, i) {
                  //if (d[factorSelected] != 0 && d[healthList[k].value] != 0 && d.time == selectedYear) { 
                  return xscale(d[factorSelected]);
                })
                .attr("cy", function (d) {
                  return hscale(d[healthList[k].value]);
                })
                .attr("location", function (d) { return d.location; });
              var lineValues = create_data(healthList[k].value);
              d3.select("._cancer").append("line")
                .attr("stroke", colorLegend)
                .attr("class", "corrLine")
                .attr("id", "line6")
                .attr("stroke-width", 1.5)
                .attr("x1", lineValues[0]["x"])
                .attr("y1", lineValues[0]["yhat"])
                .attr("x2", lineValues[1]["x"])
                .attr("y2", lineValues[1]["yhat"])
                .on("mouseover", function (d) {
                  dispatch.call("eventMouseOver", this, [null, 6, colorLegend]);
                  tipCancerC.transition()
                    .duration(200)
                    .style("opacity", 1);
                    tipCancerC.html(content = "<span style=\"display: block;background-color: rgb(0,0,0); opacity:0.7;color: white; text-shadow:none; padding:9px; top:0px\">" +
                    "<b>Correlation: </b>" + arrayCorrelation[6].toFixed(3) + "</span>")
                    .style("left", (d3.event.pageX) + "px")
                    .style("top", (d3.event.pageY - 28) + "px");
                })
                .on("mouseout", function (d) {
                  dispatch.call("eventMouseOut", this, [null, 6, colorLegend]);
                  tipCancerC.transition()
                    .duration(500)
                    .style("opacity", 0);
                });
            }
          }
          else {
            var lineValues = create_data(healthList[k].value);
            svg.select(".textBottom")
                // .attr("fill", "black")
                //   .attr("text-anchor", "middle")  // this makes it easy to centre the text as the transform is applied to the anchor
                //   .attr("transform", "translate(" + (w/2) + "," + (h ) + ")")  // text is drawn off the screen top left, move down and out and rotate
                .transition()
                .duration(500)  
                .text(getKeyByValue(dict, factorSelected));

            d3.selectAll(".corrLine")
              .transition()
              .duration(500)
              .attr("stroke", colorLegend)
              .attr("x1", lineValues[0]["x"])
              .attr("y1", lineValues[0]["yhat"])
              .attr("x2", lineValues[1]["x"])
              .attr("y2", lineValues[1]["yhat"]) ;
         
              
              if (healthList[k].value == "obese") {
              svg.selectAll(".circleScatter").remove();
              svg.selectAll(".circleScatter")
                .data(dataset.filter(function (d) { return d.time == selectedYear; }).filter(function (d) { return d[factorSelected] != ""; }).filter(function (d) { return d[healthList[k].value] != ""; }))
                .enter().append("circle")
                .style("opacity", 0.7)
                .on("mouseover.circle", function (d, i) {
                  dispatch.call("eventMouseOver", this, [d3.select(this).attr("location"), 1, colorLegend]);
                })
                .on("mouseout.circle", function (d, i) {
                  dispatch.call("eventMouseOut", this, [d3.select(this).attr("location"), 1, colorLegend]);
                })
                .on("mouseover", function (d) {
                  tipObese.transition()
                    .duration(200)
                    .style("opacity", 1);
                    var dd = d[factorSelected] > 1000 ? (d[factorSelected]/1000).toFixed(2) + "k" : d[factorSelected].toFixed(2);
                  tipObese.html(content = "<span style=\"display: block;background-color: rgb(0,0,0); opacity:0.7;color: white; text-shadow:none; padding:9px; top:0px\">" +
                    "<b>Location: </b>" + countryCodes[d.location] + "</br>" +
                    "<b>Obese: </b>" + d["obese"] + " % </br>" +
                    "<b>" + getKeyByValue(dict, factorSelected) + "</b>: " + dd + " " + dictUnit[getKeyByValue(dict, factorSelected)]+ "</br>" +
                    "</span>")
                    .style("left", (d3.event.pageX) + "px")
                    .style("top", (d3.event.pageY - 28) + "px");
                })
                .on("mouseout", function (d) {
                  tipObese.transition()
                    .duration(500)
                    .style("opacity", 0);
                })
                .attr("cx", function (d, i) {
                  //if (d[factorSelected] != 0 && d[healthList[k].value] != 0 && d.time == selectedYear) { 
                  return xscale(d[factorSelected]);
                })
                .attr("cy", function (d) {
                  return hscale(d[healthList[k].value]);
                })
                .attr("location", function (d) { return d.location; })
                .attr("r", r)
                .attr("class", "circleScatter " + healthList[k].value)
                .attr("id", (d, i) => "scatter_" + i)
                .attr("fill", colorLegend)
                ;

               
            }
            else if (healthList[k].value == "alcohol") {
              svg.selectAll(".circleScatter").remove();
              svg.selectAll(".circleScatter")
                .data(dataset.filter(function (d) { return d.time == selectedYear; }).filter(function (d) { return d[factorSelected] != ""; }).filter(function (d) { return d[healthList[k].value] != ""; }))
                .enter().append("circle")
                .style("opacity", 0.7)
                .on("mouseover.circle", function (d, i) {
                  dispatch.call("eventMouseOver", this, [d3.select(this).attr("location"), 0, colorLegend]);
                })
                .on("mouseout.circle", function (d, i) {
                  dispatch.call("eventMouseOut", this, [d3.select(this).attr("location"), 0, colorLegend]);
                })
                .on("mouseover", function (d) {
                  tipAlcohol.transition()
                    .duration(200)
                    .style("opacity", 1);
                    var dd = d[factorSelected] > 1000 ? (d[factorSelected]/1000).toFixed(2) + "k" : d[factorSelected].toFixed(2);
                    
                    tipAlcohol.html(content = "<span style=\"display: block;background-color: rgb(0,0,0); opacity:0.7;color: white; text-shadow:none; padding:9px; top:0px\">" +
                      "<b>Location: </b>" + countryCodes[d.location] + "</br>" +
                      "<b>Alcohol: </b>" + d["alcohol"] + " lt/cap </br>" +
                      "<b>" + getKeyByValue(dict, factorSelected) + "</b>: " + dd + " " + dictUnit[getKeyByValue(dict, factorSelected)]+ "</br>" +

                    "</span>")
                    .style("left", (d3.event.pageX) + "px")
                    .style("top", (d3.event.pageY - 28) + "px");
                })
                .on("mouseout", function (d) {
                  tipAlcohol.transition()
                    .duration(500)
                    .style("opacity", 0);
                })
                .attr("r", r)
                .attr("class", "circleScatter " + healthList[k].value)
                .attr("fill", colorLegend)
                .attr("id", (d, i) => "scatter_" + i)
                .attr("cx", function (d, i) {
                  //if (d[factorSelected] != 0 && d[healthList[k].value] != 0 && d.time == selectedYear) { 
                  return xscale(d[factorSelected]);
                })
                .attr("cy", function (d) {
                  return hscale(d[healthList[k].value]);
                })
                .attr("location", function (d) { return d.location; });

             
            }
            else if (healthList[k].value == "smokers") {
              svg.selectAll(".circleScatter").remove();
              svg.selectAll(".circleScatter")
                .data(dataset.filter(function (d) { return d.time == selectedYear; }).filter(function (d) { return d[factorSelected] != ""; }).filter(function (d) { return d[healthList[k].value] != ""; }))
                .enter().append("circle")
                .style("opacity", 0.7)
                .on("mouseover.circle", function (d, i) {
                  dispatch.call("eventMouseOver", this, [d3.select(this).attr("location"), 2, colorLegend]);
                })
                .on("mouseout.circle", function (d, i) {
                  dispatch.call("eventMouseOut", this, [d3.select(this).attr("location"), 2, colorLegend]);
                })
                .on("mouseover", function (d) {
                  tipSmokers.transition()
                    .duration(200)
                    .style("opacity", 1);
                    var dd = d[factorSelected] > 1000 ? (d[factorSelected]/1000).toFixed(2) + "k" : d[factorSelected].toFixed(2);
                    
                    tipSmokers.html(content = "<span style=\"display: block;background-color: rgb(0,0,0); opacity:0.7;color: white; text-shadow:none; padding:9px; top:0px\">" +
                      "<b>Location: </b>" + countryCodes[d.location] + "</br>" +
                      "<b>Smokers: </b>" + d["smokers"] + " % </br>" +
                      "<b>" + getKeyByValue(dict, factorSelected) + "</b>: " + dd + " " + dictUnit[getKeyByValue(dict, factorSelected)]+ "</br>" +
                    "</span>")
                    .style("left", (d3.event.pageX) + "px")
                    .style("top", (d3.event.pageY - 28) + "px");
                })
                .on("mouseout", function (d) {
                  tipSmokers.transition()
                    .duration(500)
                    .style("opacity", 0);
                })
                .attr("r", r)
                .attr("class", "circleScatter " + healthList[k].value)
                .attr("fill", colorLegend)
                .attr("id", (d, i) => "scatter_" + i)
                .attr("cx", function (d, i) {
                  //if (d[factorSelected] != 0 && d[healthList[k].value] != 0 && d.time == selectedYear) { 
                  return xscale(d[factorSelected]);
                })
                .attr("cy", function (d) {
                  return hscale(d[healthList[k].value]);
                })
                .attr("location", function (d) { return d.location; });

             
            }
            else if (healthList[k].value == "life_at_birth") {
              svg.selectAll(".circleScatter").remove();
              svg.selectAll(".circleScatter")
                .data(dataset.filter(function (d) { return d.time == selectedYear; }).filter(function (d) { return d[factorSelected] != ""; }).filter(function (d) { return d[healthList[k].value] != ""; }))
                .enter().append("circle")
                .style("opacity", 0.7)
                .on("mouseover.circle", function (d, i) {
                  dispatch.call("eventMouseOver", this, [d3.select(this).attr("location"), 3, colorLegend]);
                })
                .on("mouseout.circle", function (d, i) {
                  dispatch.call("eventMouseOut", this, [d3.select(this).attr("location"), 3, colorLegend]);
                })
                .on("mouseover", function (d) {
                  tipLifeAtBirth.transition()
                    .duration(200)
                    .style("opacity", 1);
                    var dd = d[factorSelected] > 1000 ? (d[factorSelected]/1000).toFixed(2) + "k" : d[factorSelected].toFixed(2);
                    
                    tipLifeAtBirth.html(content = "<span style=\"display: block;background-color: rgb(0,0,0); opacity:0.7;color: white; padding:9px;text-shadow:none; top:0px\">"
                      + "<b>Location: </b>" + countryCodes[d.location] + "</br>" +
                      "<b>Life at birth: </b>" + d["life_at_birth"] + " years </br>" +
                      "<b>" + getKeyByValue(dict, factorSelected) + "</b>: " + dd + " " + dictUnit[getKeyByValue(dict, factorSelected)]+ "</br>" + "</span>")
                    .style("left", (d3.event.pageX) + "px")
                    .style("top", (d3.event.pageY - 28) + "px");
                })
                .on("mouseout", function (d) {
                  tipLifeAtBirth.transition()
                    .duration(500)
                    .style("opacity", 0);
                })
                .attr("r", r)
                .attr("class", "circleScatter " + healthList[k].value)
                .attr("fill", colorLegend)
                .attr("id", (d, i) => "scatter_" + i)
                .attr("cx", function (d, i) {
                  //if (d[factorSelected] != 0 && d[healthList[k].value] != 0 && d.time == selectedYear) { 
                  return xscale(d[factorSelected]);
                })
                .attr("cy", function (d) {
                  return hscale(d[healthList[k].value]);
                })
                .attr("location", function (d) { return d.location; });

              
            }
            else if (healthList[k].value == "life_at_old") {
              svg.selectAll(".circleScatter").remove();
              svg.selectAll(".circleScatter")
                .data(dataset.filter(function (d) { return d.time == selectedYear; }).filter(function (d) { return d[factorSelected] != ""; }).filter(function (d) { return d[healthList[k].value] != ""; }))
                .enter().append("circle")
                .style("opacity", 0.7)
                .on("mouseover.circle", function (d, i) {
                  dispatch.call("eventMouseOver", this, [d3.select(this).attr("location"), 4, colorLegend]);
                })
                .on("mouseout.circle", function (d, i) {
                  dispatch.call("eventMouseOut", this, [d3.select(this).attr("location"), 4, colorLegend]);
                })
                .on("mouseover", function (d) {
                  tipLifeAtOld.transition()
                    .duration(200)
                    .style("opacity", 1);
                    var dd = d[factorSelected] > 1000 ? (d[factorSelected]/1000).toFixed(2) + "k" : d[factorSelected].toFixed(2);
                    
                    tipLifeAtOld.html(content = "<span style=\"display: block;background-color: rgb(0,0,0); opacity:0.7;color: white; padding:9px;text-shadow:none; top:0px\">"
                      + "<b>Location: </b>" + countryCodes[d.location] + "</br>" +
                      "<b>Life at old: </b>" + d["life_at_old"] + " years </br>" +
                      "<b>" + getKeyByValue(dict, factorSelected) + "</b>: " + dd + " " + dictUnit[getKeyByValue(dict, factorSelected)]+ "</br>" +
                    "</span>")
                    .style("left", (d3.event.pageX) + "px")
                    .style("top", (d3.event.pageY - 28) + "px");
                })
                .on("mouseout", function (d) {
                  tipLifeAtOld.transition()
                    .duration(500)
                    .style("opacity", 0);
                })
                .attr("r", r)
                .attr("class", "circleScatter " + healthList[k].value)
                .attr("fill", colorLegend)
                .attr("id", (d, i) => "scatter_" + i)
                .attr("cx", function (d, i) {
                  //if (d[factorSelected] != 0 && d[healthList[k].value] != 0 && d.time == selectedYear) { 
                  return xscale(d[factorSelected]);
                })
                .attr("cy", function (d) {
                  return hscale(d[healthList[k].value]);
                })
                .attr("location", function (d) { return d.location; });

            }
            else if (healthList[k].value == "suicide") {
              svg.selectAll(".circleScatter").remove();
              svg.selectAll(".circleScatter")
                .data(dataset.filter(function (d) { return d.time == selectedYear; }).filter(function (d) { return d[factorSelected] != ""; }).filter(function (d) { return d[healthList[k].value] != ""; }))
                .enter().append("circle")
                .style("opacity", 0.7)
                .on("mouseover.circle", function (d, i) {
                  dispatch.call("eventMouseOver", this, [d3.select(this).attr("location"), 5, colorLegend]);
                })
                .on("mouseout.circle", function (d, i) {
                  dispatch.call("eventMouseOut", this, [d3.select(this).attr("location"), 5, colorLegend]);
                })
                .on("mouseover", function (d) {
                  tipSuicide.transition()
                    .duration(200)
                    .style("opacity", 1);
                    var dd = d[factorSelected] > 1000 ? (d[factorSelected]/1000).toFixed(2) + "k" : d[factorSelected].toFixed(2);
                    
                    tipSuicide.html(content = "<span style=\"display: block;background-color: rgb(0,0,0); opacity:0.7;color: white; padding:9px;text-shadow:none; top:0px\">"
                      + "<b>Location: </b>" + countryCodes[d.location] + "</br>" +
                      "<b>Suicide: </b>" + d["suicide"] + " per 100 000 persons</br>" +
                      "<b>" + getKeyByValue(dict, factorSelected) + "</b>: " + dd + " " + dictUnit[getKeyByValue(dict, factorSelected)]+ "</br>" +
                     "</span>")
                    .style("left", (d3.event.pageX) + "px")
                    .style("top", (d3.event.pageY - 28) + "px");
                })
                .on("mouseout", function (d) {
                  tipSuicide.transition()
                    .duration(500)
                    .style("opacity", 0);
                })
                .attr("r", r)
                .attr("class", "circleScatter " + healthList[k].value)
                .attr("fill", colorLegend)
                .attr("id", (d, i) => "scatter_" + i)
                .attr("cx", function (d, i) {
                  //if (d[factorSelected] != 0 && d[healthList[k].value] != 0 && d.time == selectedYear) { 
                  return xscale(d[factorSelected]);
                })
                .attr("cy", function (d) {
                  return hscale(d[healthList[k].value]);
                })
                .attr("location", function (d) { return d.location; });
            
            }
            else if (healthList[k].value == "cancer") {
              svg.selectAll(".circleScatter").remove();
              svg.selectAll(".circleScatter")
                .data(dataset.filter(function (d) { return d.time == selectedYear; }).filter(function (d) { return d[factorSelected] != ""; }).filter(function (d) { return d[healthList[k].value] != ""; }))
                .enter().append("circle")
                .style("opacity", 0.7)
                .on("mouseover.circle", function (d, i) {
                  dispatch.call("eventMouseOver", this, [d3.select(this).attr("location"), 6, colorLegend]);
                })
                .on("mouseout.circle", function (d, i) {
                  dispatch.call("eventMouseOut", this, [d3.select(this).attr("location"), 6, colorLegend]);
                })
                .on("mouseover", function (d) {
                  tipCancer.transition()
                    .duration(200)
                    .style("opacity", 1);
                    var dd = d[factorSelected] > 1000 ? (d[factorSelected]/1000).toFixed(2) + "k" : d[factorSelected].toFixed(2);
                    
                    tipCancer.html(content = "<span style=\"display: block;background-color: rgb(0,0,0); opacity:0.7;color: white; padding:9px;text-shadow:none; top:0px\">"
                      + "<b>Location: </b>" + countryCodes[d.location] + "</br>" +
                      "<b>Cancer: </b>" + d["cancer"] + " per 100 000 persons </br>" +
                      "<b>" + getKeyByValue(dict, factorSelected) + "</b>: " + dd + " " + dictUnit[getKeyByValue(dict, factorSelected)]+ "</br>" +
                       "</span>")
                    .style("left", (d3.event.pageX) + "px")
                    .style("top", (d3.event.pageY - 28) + "px");
                })
                .on("mouseout", function (d) {
                  tipCancer.transition()
                    .duration(500)
                    .style("opacity", 0);
                })
                .attr("r", r)
                .attr("class", "circleScatter " + healthList[k].value)
                .attr("fill", colorLegend)
                .attr("id", (d, i) => "scatter_" + i)
                .attr("cx", function (d, i) {
                  //if (d[factorSelected] != 0 && d[healthList[k].value] != 0 && d.time == selectedYear) { 
                  return xscale(d[factorSelected]);
                })
                .attr("cy", function (d) {
                  return hscale(d[healthList[k].value]);
                })
                .attr("location", function (d) { return d.location; });
             
            }
          
          }
        

        }



        function create_data(health_var) {

          var values = scatter.filter(function (d) { return d.time == selectedYear; }).filter(function (d) { return d[factorSelected] != ""; }).filter(function (d) { return d[health_var] != ""; });
          var x = [];
          var y = [];
          var x_mean = 0;
          var y_mean = 0;
          var term1 = 0;
          var term2 = 0;
          for (var i = 0; i < values.length; i++) {
            x.push(xscale(values[i][factorSelected]));
            y.push(hscale(values[i][health_var]));
            x_mean += x[i];
            y_mean += y[i];

          }

          x_mean /= x.length;
          y_mean /= y.length;

          var xr = 0;
          var yr = 0;
          for (i = 0; i < x.length; i++) {
            xr = x[i] - x_mean;
            yr = y[i] - y_mean;
            term1 += xr * yr;
            term2 += xr * xr;

          }
          var b1 = term1 / term2;
          var b0 = y_mean - (b1 * x_mean);
          // perform regression 

          yhat = [];
          // fit line using coeffs
          for (i = 0; i < x.length; i++) {
            yhat.push(b0 + (x[i] * b1));
          }


          var data = [];
          for (i = 0; i < y.length; i++) {
            data.push({
              "yhat": yhat[i],
              "y": y[i],
              "x": x[i]
            })
          }
          var minLine = 1000000;
          var maxLine = 0;
          var minValues = {};
          var maxValues = {};
          for (let dataIndex = 0; dataIndex < data.length; dataIndex++) {
            if (data[dataIndex]["x"] > maxLine) {
              maxLine = data[dataIndex]["x"];
              maxValues = data[dataIndex];
            }
            if (data[dataIndex]["x"] < minLine) {
              minLine = data[dataIndex]["x"];
              minValues = data[dataIndex];
            }
          }
          return [minValues, maxValues];
        }

      }

      function drawBoxPlot(scatter, yearSelected, factorSelected, onCreate, colorLegend, mapInteraction) {
        if(factorSelected == "average_wages"){
          d3.select("#titleBoxPlot").text("Relationship between average wage and health factors");
        }
        else if(factorSelected == "hours_worked"){
          d3.select("#titleBoxPlot").text("Relationship between hours worked and health factors");
        }
        else if(factorSelected == "education"){
          d3.select("#titleBoxPlot").text("Relationship between people with upper education and health factors");
        }
        else if(factorSelected == "pollution"){
          d3.select("#titleBoxPlot").text("Relationship between pollution and health factors");
        }
        else if(factorSelected == "gdp"){
          d3.select("#titleBoxPlot").text("Relationship between GDP and health factors");
        }
        else if(factorSelected == "social_spending"){
          d3.select("#titleBoxPlot").text("Relationship between social spending and health factors");
        }
        else if(factorSelected == "employment_rate"){
          d3.select("#titleBoxPlot").text("Relationship between employment rate and health factors");
        }
        else{
          d3.select("#titleMap").text("Relationship between happiness and health");
        }
        var healthList = [
          { title: getKeyByValue(dict, factorSelected), value: factorSelected, dataArr: [] },
          { title: "Obese", value: "obese", dataArr: [] },
          { title: "Alcohol", value: "alcohol", dataArr: [] },
          { title: "Smokers", value: "smokers", dataArr: [] },
          { title: "Life expect (0)", value: "life_at_birth", dataArr: [] },
          { title: "Life expect (65)", value: "life_at_old", dataArr: [] },
          { title: "Suicide rate", value: "suicide", dataArr: [] },
          { title: "Cancer deaths", value: "cancer", dataArr: [] }
        ];
        var width_ = 90;
        var height_ = 165;
        var margin = { top: 40, right: 30, bottom: 20, left: 20 };
        var width = width_ - margin.left - margin.right;
        var height = height_ - margin.top - margin.bottom;
        var barWidth = 20;
        var boxPlotColor = "#898989";
        var tipBP_factor = d3.select("body").append("div")
          .attr("class", "tooltip")
          .style("opacity", 0);

        for (var i = 0; i < healthList.length; i++) {
          temp = [];
          for (let k = 0; k < scatter.length; k++) {
            if (scatter[k]["time"] == yearSelected && scatter[k][healthList[i]["value"]] != "") {
              temp.push(scatter[k][healthList[i]["value"]]);
            }
          }
          temp.sort(function (a, b) {
            return a - b;
          })
          healthList[i]["dataArr"] = temp;

          var max = 0;
          var min = 9999999;

          var dataArrAux = healthList[i]["dataArr"];
          for (var index = 0; index < dataArrAux.length; index++) {
            if (dataArrAux[index] > max) {
              max = dataArrAux[index];
            }
            if (dataArrAux[index] < min) {
              min = dataArrAux[index];
            }
          }

          var dataBox = {};
          dataBox["key"] = healthList[i]["title"];
          dataBox["arr"] = healthList[i]["dataArr"];
          dataBox["quartile"] = boxQuartiles(healthList[i]["dataArr"]);
          dataBox["whiskers"] = [min, max];
          dataBox["color"] = colorLegend;
          var plotData = [dataBox];

          var xScale = d3.scalePoint()
            .domain([dataBox["key"]])
            .rangeRound([0, width])
            .padding([0.5]);

          var yScale = d3.scaleLinear()
            .range([height, 0])
            .domain([min, max])
            .nice();

          var xAxis = d3.axisBottom().scale(xScale);
          var yAxis = max>1000 ? d3.axisLeft(yScale).ticks(4).tickFormat(d=>(d/1000 + "k")) : d3.axisLeft(yScale).ticks(4);

          var box_name = i == 0 ? "factor" : healthList[i]["value"];


          if (onCreate) {
            var svg = d3.select(".boxPlot").append("svg")
              .attr("class", "box_" + box_name)
              .attr("width", width_)
              .attr("height", 185)
              .append("g")
              .attr("transform", "translate(" + (margin.left - barWidth) + "," + margin.top + ")");

            var yAxisBox = svg.append("g")
              .attr("class", "yAxisBox_" + box_name)
              .attr("transform", "translate(40,0)")
              .append("g")
                .attr("class", "y_axis")
                .call(yAxis);
            var xAxisBox = svg.append("g")
              .attr("class", "xAxisBox_" + box_name)
              .attr("transform", "translate(40,0)")
              .append("g")
              .attr("class", "x_axis")
              .attr("width", barWidth)
              .attr("height", "30")
              .attr("transform", "translate(0," + height + ")")
              .call(xAxis)
              .select("text")
              .call(wrap, 40) 
              ;
            var g = svg.append("g")
              .attr("class", "boxRender_" + box_name)
              .attr("transform", "translate(20,0)");



            g.selectAll(".verticalLines")
              .data(plotData)
              .enter()
              .append("line")
              .attr("class", "verticalLines")
              .attr("transform", "translate(10,0)")
              .attr("x1", d => { return xScale(d.key) + barWidth / 2; })
              .attr("y1", d => { return yScale(d.whiskers[0]); })
              .attr("x2", d => { return xScale(d.key) + barWidth / 2; })
              .attr("y2", d => { return yScale(d.whiskers[1]); })
              .attr("stroke", boxPlotColor)
              .attr("stroke-width", 1)
              .attr("fill", "none");

              
              g.selectAll("rect")
              .data(plotData)
              .enter()
              .append("rect")
              .attr("class", "recta")
              .attr("transform", "translate(10,0)")
              .attr("width", barWidth)
              .attr("height", d => { return yScale(d.quartile[2]) - yScale(d.quartile[0]); })
              .attr("x", d => { return xScale(d.key); })
              .attr("y", d => { return yScale(d.quartile[0]); })
              .attr("fill", d => { return d.color; })
              .attr("stroke", boxPlotColor)
              .attr("stroke-width", 1)
              .on("mouseover", function (d) {
                var bp_max =  d.whiskers[1] > 1000 ? (d.whiskers[1]/1000).toFixed(2) + "k" : d.whiskers[1].toFixed(2);
                var bp_q3 = d.quartile[0] > 1000 ? (d.quartile[0]/1000).toFixed(2) + "k" : d.quartile[0].toFixed(2);
                var bp_median = d.quartile[1] > 1000 ? (d.quartile[1]/1000).toFixed(2) + "k" : d.quartile[1].toFixed(2);
                var bp_q1 = d.quartile[2] > 1000 ? (d.quartile[2]/1000).toFixed(2) + "k" : d.quartile[2].toFixed(2);
                var bp_min = d.whiskers[0] > 1000 ? (d.whiskers[0]/1000).toFixed(2) + "k" : d.whiskers[0].toFixed(2);
                tipBP_factor.transition()
                  .duration(200)
                  .style("opacity", 1);
                  
                tipBP_factor.html(content =
                  "<span style=\"display: block;background-color: rgb(0,0,0); opacity:0.7;color: white; padding:9px;text-shadow:none; top:0px\">"
                  + "<b>Max: </b>" + bp_max + " " + "</br>"
                  + "<b>Q3: </b>" + bp_q3 + "</br>"
                  + "<b>Median: </b>" + bp_median + "</br>"
                  + "<b>Q1: </b>" + bp_q1 + "</br>"
                  + "<b>Min: </b>" + bp_min + "</br>"
                  + "</span>")
                  .style("left", (d3.event.pageX) + "px")
                  .style("top", (d3.event.pageY - 28) + "px");
              })
              .on("mouseout", function (d) {
                tipBP_factor.transition()
                  .duration(500)
                  .style("opacity", 0);
              });


              var horizontalLineConfigs = [
              {   // Top whisker
                x1: d => { return xScale(d.key) },
                y1: d => { return yScale(d.whiskers[0]) },
                x2: d => { return xScale(d.key) + barWidth },
                y2: d => { return yScale(d.whiskers[0]) },
                color: boxPlotColor
              },
              {   // Median
                x1: d => { return xScale(d.key) },
                y1: d => { return yScale(d.quartile[1]) },
                x2: d => { return xScale(d.key) + barWidth },
                y2: d => { return yScale(d.quartile[1]) },
                color: "#ffffff"
              },
              {   // Bottom whisker
                x1: d => { return xScale(d.key) },
                y1: d => { return yScale(d.whiskers[1]) },
                x2: d => { return xScale(d.key) + barWidth },
                y2: d => { return yScale(d.whiskers[1]) },
                color: boxPlotColor
              },
              {   
                x1: d => { return xScale(d.key) },
                y1: d => { return yScale(d.arr) },
                x2: d => { return xScale(d.key) + barWidth },
                y2: d => { return yScale(d.arr) },
                color: boxPlotColor
              }
              ];


              g.selectAll(".whiskers")
              .data(plotData)
              .enter()
              .append("line")
              .attr("id", "linePlot" + 0)
              .attr("transform", "translate(10,0)")
              .attr("x1", horizontalLineConfigs[0].x1)
              .attr("y1", horizontalLineConfigs[0].y1)
              .attr("x2", horizontalLineConfigs[0].x2)
              .attr("y2", horizontalLineConfigs[0].y2)
              .attr("stroke", horizontalLineConfigs[0].color)
              .attr("stroke-width", 1)
              .attr("fill", "none");

              g.selectAll(".whiskers")
              .data(plotData)
              .enter()
              .append("line")
              .attr("id", "linePlot" + 1)
              .attr("transform", "translate(10,0)")
              .attr("x1", horizontalLineConfigs[1].x1)
              .attr("y1", horizontalLineConfigs[1].y1)
              .attr("x2", horizontalLineConfigs[1].x2)
              .attr("y2", horizontalLineConfigs[1].y2)
              .attr("stroke", horizontalLineConfigs[1].color)
              .attr("stroke-width", 1)
              .attr("fill", "none");

              g.selectAll(".whiskers")
              .data(plotData)
              .enter()
              .append("line")
              .attr("id", "linePlot" + 2)
              .attr("transform", "translate(10,0)")
              .attr("x1", horizontalLineConfigs[2].x1)
              .attr("y1", horizontalLineConfigs[2].y1)
              .attr("x2", horizontalLineConfigs[2].x2)
              .attr("y2", horizontalLineConfigs[2].y2)
              .attr("stroke", horizontalLineConfigs[2].color)
              .attr("stroke-width", 1)
              .attr("fill", "none");

              // add the Y gridlines
              svg.append("g")
                .attr("transform", "translate(40,0)")
                .attr("class", "grid")

          } 
          else {
            var svg = d3.select(".box_" + box_name);
            var yAxisBox = svg.select(".yAxisBox_" + box_name);
            var xAxisBox = svg.select(".xAxisBox_" + box_name).attr("transform", "translate(40,0)");;
            var xAxisUpdate = svg.select(".x_axis");
            var yAxisUpdate = svg.select(".y_axis");
            var g = d3.select(".boxRender_" + box_name);

            if(mapInteraction){

              var dataToLine_factor = [];
              var dataToLine_obese = [];
              var dataToLine_alcohol = [];
              var dataToLine_smokers = [];
              var dataToLine_lifeOld = [];
              var dataToLine_lifeBirth = [];
              var dataToLine_suicide = [];
              var dataToLine_cancer = [];

              for (var o = 0; o < scatter.length; o++) {
                if(scatter[o]["time"] == yearSelected && scatter[o][factorSelected] != ""){
                  if(scatter[o]["location"] == mapInteraction){
                    console.log(scatter[o]);
                    if([scatter[o][factorSelected]]!= ""){
                      dataToLine_factor= [scatter[o][factorSelected]];
                    }
                    if([scatter[o]["obese"]]!= ""){
                      dataToLine_obese= [scatter[o]["obese"]];
                    }
                    if([scatter[o]["alcohol"]]!= ""){
                      dataToLine_alcohol= [scatter[o]["alcohol"]];
                    }
                    if([scatter[o]["smokers"]] != ""){
                      console.log("ss");
                      dataToLine_smokers= [scatter[o]["smokers"]];
                    }
                    if([scatter[o]["suicide"]]!= ""){
                      dataToLine_suicide [scatter[o]["suicide"]];
                    }
                    if([scatter[o]["life_at_old"]]!= ""){
                      dataToLine_lifeOld= [scatter[o]["life_at_old"]];
                    }
                    if([scatter[o]["life_at_birth"]]!= ""){
                      dataToLine_lifeBirth= [scatter[o]["life_at_birth"]];
                    }
                    if([scatter[o]["cancer"]]!= ""){
                      dataToLine_cancer = [scatter[o]["cancer"]];
                    }
                  }
                }}
              if(i == 0  && dataToLine_factor!=[]){
                g.selectAll(".whiskers")
                .data(dataToLine_factor)
                .enter()
                .append("circle")
                .attr("id", "linePlot50")
                .attr("transform", "translate(10,0)")
                .attr("cx", 30)
                .attr("cy", d => yScale(d))
                .attr("r",4)
                .style("opacity",1)
                .attr("stroke", "black")
                .attr("stroke-width", 1)
                .attr("fill", "white");
              }else if(i==1 && dataToLine_obese !=[]){
                g.selectAll(".whiskers")
                .data(dataToLine_obese)
                .enter()
                .append("circle")
                .attr("id", "linePlot50")
                .attr("transform", "translate(10,0)")
                .attr("cx", 30)
                .attr("cy", d => yScale(d))
                .attr("r",4)
                .style("opacity",1)
                .attr("stroke", "black")
                .attr("stroke-width", 1)
                .attr("fill", "white");
              }
              else if(i==2 && dataToLine_alcohol !=[]){
                g.selectAll(".whiskers")
                .data(dataToLine_alcohol)
                .enter()
                .append("circle")
                .attr("id", "linePlot50")
                .attr("transform", "translate(10,0)")
                .attr("cx", 30)
                .attr("cy", d => yScale(d))
                .attr("r",4)
                .style("opacity",1)
                .attr("stroke", "black")
                .attr("stroke-width", 1)
                .attr("fill", "white");
              }
              else if(i==3 && dataToLine_smokers !=[]){
                g.selectAll(".whiskers")
                .data(dataToLine_smokers)
                .enter()
                .append("circle")
                .attr("id", "linePlot50")
                .attr("transform", "translate(10,0)")
                .attr("cx", 30)
                .attr("cy", d => yScale(d))
                .attr("r",4)
                .style("opacity",1)
                .attr("stroke", "black")
                .attr("stroke-width", 1)
                .attr("fill", "white");
              }
              else if(i==4 && dataToLine_lifeBirth !=[]){
                g.selectAll(".whiskers")
                .data(dataToLine_lifeBirth)
                .enter()
                .append("circle")
                .attr("id", "linePlot50")
                .attr("transform", "translate(10,0)")
                .attr("cx", 30)
                .attr("cy", d => yScale(d))
                .attr("r",4)
                .style("opacity",1)
                .attr("stroke", "black")
                .attr("stroke-width", 1)
                .attr("fill", "white");
              }
              else if(i==5 && dataToLine_lifeOld !=[]){
                g.selectAll(".whiskers")
                .data(dataToLine_lifeOld)
                .enter()
                .append("circle")
                .attr("id", "linePlot50")
                .attr("transform", "translate(10,0)")
                .attr("cx", 30)
                .attr("cy", d => yScale(d))
                .attr("r",4)
                .style("opacity",1)
                .attr("stroke", "black")
                .attr("stroke-width", 1)
                .attr("fill", "white");
              }
              else if(i==6 && dataToLine_suicide !=[]){
                g.selectAll(".whiskers")
                .data(dataToLine_suicide)
                .enter()
                .append("circle")
                .attr("id", "linePlot50")
                .attr("transform", "translate(10,0)")
                .attr("cx", 30)
                .attr("cy", d => yScale(d))
                .attr("r",4)
                .style("opacity",1)
                .attr("stroke", "black")
                .attr("stroke-width", 1)
                .attr("fill", "white");
              }
              else if(i==7 && dataToLine_cancer !=[]){
                g.selectAll(".whiskers")
                .data(dataToLine_cancer)
                .enter()
                .append("circle")
                .attr("id", "linePlot50")
                .attr("transform", "translate(10,0)")
                .attr("cx", 30)
                .attr("cy", d => yScale(d))
                .attr("r",4)
                .style("opacity",1)
                .attr("stroke", "black")
                .attr("stroke-width", 1)
                .attr("fill", "white");
              }
            }

            g.selectAll(".verticalLines")
              .data(plotData)
              .transition()
              .duration(500)
              .attr("x1", d => { return xScale(d.key) + barWidth / 2; })
              .attr("y1", d => { return yScale(d.whiskers[0]); })
              .attr("x2", d => { return xScale(d.key) + barWidth / 2; })
              .attr("y2", d => { return yScale(d.whiskers[1]); });

            g.selectAll("rect")
              .data(plotData)
              .transition()
              .duration(500)
              .attr("height", d => { return yScale(d.quartile[2]) - yScale(d.quartile[0]); })
              .attr("x", d => { return xScale(d.key); })
              .attr("y", d => { return yScale(d.quartile[0]); })
              .attr("fill", d => { return d.color; })
              ;
            var horizontalLineConfigs = [
              {   // Top whisker
                x1: d => { return xScale(d.key) },
                y1: d => { return yScale(d.whiskers[0]) },
                x2: d => { return xScale(d.key) + barWidth },
                y2: d => { return yScale(d.whiskers[0]) },
                color: boxPlotColor
              },
              {   // Median
                x1: d => { return xScale(d.key) },
                y1: d => { return yScale(d.quartile[1]) },
                x2: d => { return xScale(d.key) + barWidth },
                y2: d => { return yScale(d.quartile[1]) },
                color: "#ffffff"
              },
              {   // Bottom whisker
                x1: d => { return xScale(d.key) },
                y1: d => { return yScale(d.whiskers[1]) },
                x2: d => { return xScale(d.key) + barWidth },
                y2: d => { return yScale(d.whiskers[1]) },
                color: boxPlotColor
              }
            ];

            g.select("#linePlot0")
              .data(plotData)
              .transition()
              .duration(500)
              .attr("x1", horizontalLineConfigs[0].x1)
              .attr("y1", horizontalLineConfigs[0].y1)
              .attr("x2", horizontalLineConfigs[0].x2)
              .attr("y2", horizontalLineConfigs[0].y2)
              .attr("stroke", horizontalLineConfigs[0].color);

            g.select("#linePlot1")
              .data(plotData)
              .transition()
              .duration(500)
              .attr("x1", horizontalLineConfigs[1].x1)
              .attr("y1", horizontalLineConfigs[1].y1)
              .attr("x2", horizontalLineConfigs[1].x2)
              .attr("y2", horizontalLineConfigs[1].y2)
              .attr("stroke", horizontalLineConfigs[1].color);

            g.select("#linePlot2")
              .data(plotData)
              .transition()
              .duration(500)
              .attr("x1", horizontalLineConfigs[2].x1)
              .attr("y1", horizontalLineConfigs[2].y1)
              .attr("x2", horizontalLineConfigs[2].x2)
              .attr("y2", horizontalLineConfigs[2].y2)
              .attr("stroke", horizontalLineConfigs[2].color);

            yAxisUpdate.call(yAxis);

            xAxisUpdate
              .transition()
              .duration(100)
              .attr("transform", "translate(0," + height + ")")
              .call(xAxis)
              // .transition()
              // .duration(100)
              // .select("text")
              // .call(wrap, 40)
              ;

          }


        }
      }


      function wrap(text, width) {
        text.each(function () {
          var text = d3.select(this),
            words = text.text().split(/\s+/).reverse(),
            word,
            line = [],
            lineNumber = 0,
            lineHeight = 1.1, // ems
            y = text.attr("y"),
            dy = parseFloat(text.attr("dy")),
            tspan = text.text(null).append("tspan").attr("x", 0).attr("y", y).attr("dy", dy + "em");
          console.log("------------------");
          while (word = words.pop()) {
            line.push(word);
            tspan.text(line.join(" "));
            if (tspan.node().getComputedTextLength() > width) {
              line.pop();
              tspan.text(line.join(" "));
              line = [word];
              tspan = text.append("tspan").attr("x", 0).attr("y", y).attr("dy", ++lineNumber * lineHeight + dy + "em").text(word);
            }
          }
        });
      }

      /////////////////////////////////////////////
      // function drawBoxPlot1(scatter, yearSelected, factorSelected, onCreate, colorLegend) {
      //   var healthList = [
      //     { title: getKeyByValue(dict, factorSelected), value: factorSelected, name: "factorSelected", arr: [] },
      //     { title: 'Obese', value: "obese", name: "obese", arr: [] },
      //     { title: 'Alcohol', value: "alcohol", name: "alcohol", arr: [] },
      //     { title: 'Smokers', value: "smokers", name: "smokers", arr: [] },
      //     { title: 'Life expectancy at birth', value: "life_at_birth", name: "life_at_birth", arr: [] },
      //     { title: 'Life expectancy at 65', value: "life_at_old", name: "life_at_old", arr: [] },
      //     { title: 'Suicide rate', value: "suicide", name: "suicide", arr: [] },
      //     { title: 'Deaths by cancer', value: "cancer", name: "cancer", arr: [] },
      //   ]

      //   for (var k = 0; k < healthList.length; k++) {
      //     temp = [];
      //     for (var i = 0; i < scatter.length; i++) {
      //       if (scatter[i][healthList[k].value] != "" && scatter[i].time == yearSelected) {
      //         temp.push(parseInt(scatter[i][healthList[k].value]));
      //       }
      //     }
      //     healthList[k]["arr"] = temp.sort(function (a, b) {
      //       return a - b;
      //     });
      //     var max = 0;
      //     var min = 10000;
      //     for (var i = 0; i < healthList[k].arr.length; i++) {
      //       if (healthList[k].arr[i] > max) {
      //         max = healthList[k].arr[i];
      //       }
      //       if (healthList[k].arr[i] < min) {
      //         min = healthList[k].arr[i];
      //       }
      //     }


      //     var count = 5;

      //     // Size and color settings for the chart
      //     var totalWidth = 80;
      //     var totalheight = 165;
      //     var margin = { top: 40, right: 30, bottom: 20, left: 20 },
      //       width = totalWidth - margin.left - margin.right,
      //       height = totalheight - margin.top - margin.bottom;
      //     var barWidth = 20;
      //     var boxPlotColor = "#898989";
      //     var medianLineColor = "#ffffff";
      //     var axisColor = "#898989";

      //     // Setup the svg and group we will draw the box plot in

      //     var svg = onCreate ? d3.select(".violins").append("svg")
      //       .attr("class", "box" + healthList[k].name)
      //       .attr("width", totalWidth)
      //       .attr("height", totalheight)
      //       .append("g")
      //       .attr("transform", "translate(" + (margin.left - barWidth) + "," + margin.top + ")")
      //       : d3.select(".box" + healthList[k].name);

      //     console.log(svg);

      //     // Move axis to center align the bars with the xAxis ticks
      //     var yAxisBox = onCreate ?
      //       svg.append("g").attr("class", "yAxisBox_" + healthList[k].name).attr("transform", "translate(40,0)")
      //       : svg.select(".yAxisBox_" + healthList[k].name);
      //     var xAxisBox = onCreate ?
      //       svg.append("g").attr("class", "xAxisBox_" + healthList[k].name).attr("transform", "translate(40,0)")
      //       : svg.select(".xAxisBox_" + healthList[k].name);

      //     var plotData = [];
      //     var colorIndex = 0.1;
      //     var colorIndexStepSize = 0.08;

      //     var record = {};
      //     var localMin = min;//d3.min(map);
      //     var localMax = max;//d3.max(map);

      //     record["key"] = healthList[k].title;
      //     record["counts"] = healthList[k].arr;
      //     record["quartile"] = boxQuartiles(healthList[k].arr);
      //     record["whiskers"] = [localMax, localMin];
      //     record["color"] = "#efefef";

      //     plotData.push(record);
      //     colorIndex += colorIndexStepSize;

      //     // Create Tooltips
      //     var tipVi = d3.tip().attr('class', 'd3-tip').direction('e').offset([0, 5])
      //       .html(function (d) {
      //         var content = "<span style='margin-left: 2.5px;'><b>" + d.key + "</b></span><br>";
      //         content += `
      //                           <table style="margin-top: 2.5px;">
      //                                   <tr><td>Max: </td><td style="text-align: right; text-shadow:none">` + d3.format(".2f")(d.whiskers[0]) + `</td></tr>
      //                                   <tr><td>Q3: </td><td style="text-align: right;text-shadow:none">` + d3.format(".2f")(d.quartile[0]) + `</td></tr>
      //                                   <tr><td>Median: </td><td style="text-align: right;text-shadow:none">` + d3.format(".2f")(d.quartile[1]) + `</td></tr>
      //                                   <tr><td>Q1: </td><td style="text-align: right;text-shadow:none">` + d3.format(".2f")(d.quartile[2]) + `</td></tr>
      //                                   <tr><td>Min: </td><td style="text-align: right;text-shadow:none">` + d3.format(".2f")(d.whiskers[1]) + `</td></tr>
      //                           </table>
      //                           `;
      //         return content;
      //       });
      //     // svg.call(tipVi);

      //     // Compute an ordinal xScale for the keys in plotData
      //     var xScale = d3.scalePoint()
      //       .domain([record["key"]])
      //       .rangeRound([0, width])
      //       .padding([0.5]);

      //     // Compute a global y scale based on the global counts
      //     var min = min;
      //     var max = max;
      //     var yScale = d3.scaleLinear()
      //       .range([height, 0])
      //       .domain([min, max])
      //       .nice();

      //     // Setup the group the box plot elements will render in
      //     var g = onCreate ? svg.append("g")
      //       .attr("class", "boxRender_" + factorSelected)
      //       .attr("transform", "translate(20,0)") : d3.select(".boxRender_" + factorSelected);
      //     if (true) {
      //       // Draw the box plot vertical lines

      //       g.selectAll(".verticalLines")
      //         .data(plotData)
      //         .enter()
      //         .append("line")
      //         .attr("class", "verticalLines")
      //         .attr("transform", "translate(10,0)")
      //         .attr("x1", d => { return xScale(d.key) + barWidth / 2; })
      //         .attr("y1", d => { return yScale(d.whiskers[0]); })
      //         .attr("x2", d => { return xScale(d.key) + barWidth / 2; })
      //         .attr("y2", d => { return yScale(d.whiskers[1]); })
      //         .attr("stroke", boxPlotColor)
      //         .attr("stroke-width", 1)
      //         .attr("fill", "none");

      //       // Draw the boxes of the box plot, filled in white and on top of vertical lines
      //       g.selectAll("rect")
      //         .data(plotData)
      //         .enter()
      //         .append("rect")
      //         .attr("class", "recta")
      //         .attr("transform", "translate(10,0)")
      //         .attr("width", barWidth)
      //         .attr("height", d => {
      //           return yScale(d.quartile[2]) - yScale(d.quartile[0]);
      //         })
      //         .attr("x", d => { return xScale(d.key); })
      //         .attr("y", d => { return yScale(d.quartile[0]); })
      //         .attr("fill", d => { return d.color; })
      //         .attr("stroke", boxPlotColor)
      //         .attr("stroke-width", 1);
      //       // .on('mouseover', tipVi.show)
      //       // .on('mouseout', tipVi.hide);

      //       // Config for whiskers and median
      //       var horizontalLineConfigs = [
      //         {   // Top whisker
      //           x1: d => { return xScale(d.key) },
      //           y1: d => { return yScale(d.whiskers[0]) },
      //           x2: d => { return xScale(d.key) + barWidth },
      //           y2: d => { return yScale(d.whiskers[0]) },
      //           color: boxPlotColor
      //         },
      //         {   // Median
      //           x1: d => { return xScale(d.key) },
      //           y1: d => { return yScale(d.quartile[1]) },
      //           x2: d => { return xScale(d.key) + barWidth },
      //           y2: d => { return yScale(d.quartile[1]) },
      //           color: medianLineColor
      //         },
      //         {   // Bottom whisker
      //           x1: d => { return xScale(d.key) },
      //           y1: d => { return yScale(d.whiskers[1]) },
      //           x2: d => { return xScale(d.key) + barWidth },
      //           y2: d => { return yScale(d.whiskers[1]) },
      //           color: boxPlotColor
      //         }
      //       ];

      //       // Draw the whiskers and median line
      //       for (var i = 0; i < horizontalLineConfigs.length; i++) {
      //         var lineConfig = horizontalLineConfigs[i];
      //         g.selectAll(".whiskers")
      //           .data(plotData)
      //           .enter()
      //           .append("line")
      //           .attr("id", "linePlot" + i)
      //           .attr("transform", "translate(10,0)")
      //           .attr("x1", lineConfig.x1)
      //           .attr("y1", lineConfig.y1)
      //           .attr("x2", lineConfig.x2)
      //           .attr("y2", lineConfig.y2)
      //           .attr("stroke", lineConfig.color)
      //           .attr("stroke-width", 1)
      //           .attr("fill", "none");
      //       }

      //       // add the Y gridlines
      //       svg.append("g")
      //         .attr("transform", "translate(40,0)")
      //         .attr("class", "grid")


      //       // Setup a scale on the left
      //       var yAxis = d3.axisLeft(yScale).ticks(5)
      //       yAxisBox.append("g")
      //         .attr("class", "y axis")
      //         .call(yAxis);

      //       // Setup a series axis on the bottom
      //       var xAxis = d3.axisBottom(xScale);
      //       xAxisBox.append("g")
      //         .attr("class", "x axis")
      //         .attr("width", barWidth)
      //         .attr("transform", "translate(0," + height + ")")
      //         .call(xAxis);

      //     }
      //     // else {
      //     //   d3.selectAll(".verticalLines")
      //     //     .data(plotData)
      //     //     .transition()
      //     //     .duration(500)
      //     //     .attr("x1", d => { return xScale(d.key) + barWidth / 2; })
      //     //     .attr("y1", d => { return yScale(d.whiskers[0]); })
      //     //     .attr("x2", d => { return xScale(d.key) + barWidth / 2; })
      //     //     .attr("y2", d => { return yScale(d.whiskers[1]); })
      //     //     .attr("stroke", boxPlotColor);


      //     //   // Draw the boxes of the box plot, filled in white and on top of vertical lines
      //     //   d3.selectAll(".recta")
      //     //     .data(plotData)
      //     //     .transition()
      //     //     .duration(500)
      //     //     .attr("height", d => {
      //     //       return yScale(d.quartile[2]) - yScale(d.quartile[0]);
      //     //     })
      //     //     .attr("x", d => { return xScale(d.key); })
      //     //     .attr("y", d => { return yScale(d.quartile[0]); })
      //     //     .attr("fill", d => { console.log(d); return d.color; });

      //     //   // Config for whiskers and median
      //     //   var horizontalLineConfigs = [
      //     //     {   // Top whisker
      //     //       x1: d => { return xScale(d.key) },
      //     //       y1: d => { return yScale(d.whiskers[0]) },
      //     //       x2: d => { return xScale(d.key) + barWidth },
      //     //       y2: d => { return yScale(d.whiskers[0]) },
      //     //       color: boxPlotColor
      //     //     },
      //     //     {   // Median
      //     //       x1: d => { return xScale(d.key) },
      //     //       y1: d => { return yScale(d.quartile[1]) },
      //     //       x2: d => { return xScale(d.key) + barWidth },
      //     //       y2: d => { return yScale(d.quartile[1]) },
      //     //       color: medianLineColor
      //     //     },
      //     //     {   // Bottom whisker
      //     //       x1: d => { return xScale(d.key) },
      //     //       y1: d => { return yScale(d.whiskers[1]) },
      //     //       x2: d => { return xScale(d.key) + barWidth },
      //     //       y2: d => { return yScale(d.whiskers[1]) },
      //     //       color: boxPlotColor
      //     //     }
      //     //   ];

      //     //   // Draw the whiskers and median line
      //     //   for (var i = 0; i < horizontalLineConfigs.length; i++) {
      //     //     var lineConfig = horizontalLineConfigs[i];
      //     //     d3.selectAll("#linePlot" + i)
      //     //       .data(plotData)
      //     //       .transition()
      //     //       .duration(500)
      //     //       .attr("x1", lineConfig.x1)
      //     //       .attr("y1", lineConfig.y1)
      //     //       .attr("x2", lineConfig.x2)
      //     //       .attr("y2", lineConfig.y2);
      //     //   }

      //     //   // Setup a scale on the left
      //     //   var yAxis = d3.axisLeft(yScale).ticks(5)
      //     //   yAxisBox.select(".y axis")
      //     //     .call(yAxis);

      //     //   // // Setup a series axis on the bottom
      //     //   var xAxis = d3.axisBottom(xScale);
      //     //   xAxisBox.append("g")
      //     //     .attr("class", "x axis")
      //     //     .attr("width", barWidth)
      //     //     .attr("transform", "translate(0," + height + ")")
      //     //     .call(xAxis);

      //     // }

      //   }
      // };

      function boxQuartiles(d) {
        return [
          d3.quantile(d, .75),
          d3.quantile(d, .5),
          d3.quantile(d, .25),
        ];
      };
    });
  </script>
</body>

</html>